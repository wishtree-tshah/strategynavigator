<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategy Navigator - Challenges.one</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
            --primary-blue: #0074C1;
            --primary-dark: #005a9c;
            --secondary-blue: #e6f2fb;
            --text-primary: #2c3e50;
            --text-secondary: #6c757d;
            --text-light: #95a5a6;
            --bg-white: #ffffff;
            --bg-light: #f8f9fa;
            --bg-page: #f5f7fa;
            --border-color: #dee2e6;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 2px 8px rgba(0,0,0,0.08);
            --success-green: #28a745;
            --danger-red: #dc3545;
            --warning-orange: #ffc107;
        }

        * {
            margin: 0;
            padding: 0;
      box-sizing: border-box;
    }

    body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-page);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Main Navigation Header - Modern Design */
        .main-nav {
      background: white;
            border-bottom: 1px solid var(--border-color);
            padding: 0.85rem 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .nav-container {
            max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
            align-items: center;
    }

        .nav-left {
      display: flex;
      align-items: center;
            gap: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 1.1rem;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            background: radial-gradient(circle at 30% 30%, #FF6B6B, #4ECDC4, #45B7D1, #FFA07A, #98D8C8, #F7DC6F);
      border-radius: 50%;
            position: relative;
        }

        .logo-icon::before {
            content: '';
            position: absolute;
            inset: 4px;
            background: radial-gradient(circle at 60% 60%, #667eea, #764ba2, #f093fb);
            border-radius: 50%;
            opacity: 0.8;
        }

        .nav-links {
      display: flex;
            gap: 1.5rem;
            list-style: none;
        }

        .nav-links a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
            padding: 0.5rem 0;
            position: relative;
            transition: color 0.2s;
        }

        .nav-links a:hover {
            color: var(--primary-blue);
        }

        .nav-links a.active {
            color: var(--primary-blue);
        }

        .nav-links a.active::after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary-blue);
        }

        .nav-links .dropdown {
            position: relative;
        }

        .nav-links .dropdown-toggle::after {
            content: '\f078';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 0.7rem;
            margin-left: 0.4rem;
        }

        .user-menu {
      display: flex;
      align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--primary-blue);
            color: white;
      border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-avatar-dropdown {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Welcome Section - Modern Design */
        .welcome-section {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            padding: 2.25rem 2rem;
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 1px 4px rgba(0,0,0,0.02);
        }

        .welcome-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .welcome-greeting {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.4rem;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--primary-blue) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-date {
            font-size: 0.95rem;
            color: var(--text-secondary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .welcome-date::before {
            content: '\f073';
            font-family: 'Font Awesome 6 Free';
            font-weight: 400;
        }

        /* Sub Navigation - Module Tabs */
        .sub-nav {
            background: var(--bg-white);
            border-bottom: 1px solid var(--border-color);
            padding: 0 2rem;
            position: sticky;
            top: 60px;
            z-index: 99;
        }

        .sub-nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sub-nav-tabs {
            display: flex;
            gap: 2rem;
        }

        .sub-nav-tab {
            padding: 1rem 0;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.95rem;
            color: var(--text-secondary);
            position: relative;
            text-decoration: none;
        }

        .sub-nav-tab:hover {
            color: var(--primary-blue);
        }

        .sub-nav-tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
        }

        /* Context Switcher - Dual Hat Navigation - Modern Design */
        .context-switcher {
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
            padding: 1.25rem 2rem;
            border-bottom: 2px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }

        .context-switcher-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .context-tab {
            padding: 0.9rem 2.25rem;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            position: relative;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
        }

        .context-tab:hover {
            background: var(--secondary-blue);
            color: var(--primary-blue);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 116, 193, 0.15);
        }

        .context-tab.active {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
      color: white;
            border-color: var(--primary-blue);
            box-shadow: 0 4px 16px rgba(0, 116, 193, 0.3);
            transform: translateY(-2px);
        }

        .context-tab i {
            font-size: 1.15rem;
        }

        .context-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, var(--danger-red), #c82333);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 3px 8px rgba(220, 53, 69, 0.4);
            border: 2px solid white;
        }

        .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* License/Metrics Cards - Modern Design */
        .metrics-section {
            background: var(--bg-white);
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .metrics-container {
            max-width: 1400px;
            margin: 0 auto;
      display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
        }

        .metric-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border: 1px solid var(--border-color);
            border-left: 4px solid var(--primary-blue);
            border-radius: 12px;
            padding: 1.75rem 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

        .metric-card::before {
            content: '';
      position: absolute;
            top: 0;
            right: 0;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(0, 116, 193, 0.08) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 116, 193, 0.15);
            border-left-width: 5px;
        }

        .metric-value {
            font-size: 2.75rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.5rem;
            line-height: 1;
            letter-spacing: -0.02em;
        }

        .metric-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
      font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .metric-icon {
            font-size: 2.25rem;
            color: var(--primary-blue);
            margin-bottom: 0.75rem;
            opacity: 0.9;
        }

        /* Breadcrumbs */
        .breadcrumbs {
            padding: 1rem 2rem;
            background: var(--bg-page);
            font-size: 0.9rem;
        }

        .breadcrumbs-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .breadcrumbs a {
            color: var(--text-secondary);
            text-decoration: none;
            cursor: pointer;
            transition: color 0.2s;
        }

        .breadcrumbs a:hover {
            color: var(--primary-blue);
            text-decoration: underline;
        }

        .breadcrumbs span {
            color: var(--text-light);
            margin: 0 0.5rem;
        }

        /* Main Container - Optimized Spacing */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2.5rem 4rem;
            flex: 1;
        }

        /* Improved Content Padding */
        .card > div:not(.card-header):not(.tabs) {
            padding: 2rem 2.5rem;
        }

        /* Section Spacing */
        .section-spacing {
            margin-bottom: 2rem;
        }

        .content-spacing {
            padding: 1.5rem 2rem 2rem;
        }

        /* Cards - Modern Design */
        .card {
      background: white;
            border-radius: 12px;
            padding: 0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            overflow: hidden;
            width: 1227.29px;
            max-width: 100%;
            min-height: 128.8px;
            margin-left: auto;
            margin-right: auto;
        }

        .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
            padding: 2rem 2.5rem;
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
            border-bottom: 1px solid var(--border-color);
            gap: 2rem;
    }

        .card-header > div:first-child {
            flex: 1;
            min-width: 0;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
      display: flex;
            align-items: center;
            letter-spacing: -0.02em;
            line-height: 1.3;
            margin: 0;
        }

        /* Blue vertical bar for titles (Adobe XD Theme) */
        .title-bar {
            width: 3px;
            height: 2rem;
            background: linear-gradient(180deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            margin-right: 0.85rem;
            border-radius: 2px;
            display: inline-block;
            box-shadow: 0 0 8px rgba(0, 116, 193, 0.3);
        }

        /* Buttons - Modern Design */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
      cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
            letter-spacing: 0.01em;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 116, 193, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 116, 193, 0.35);
        }

        .btn-secondary {
            background: var(--bg-white);
            color: var(--primary-blue);
            border: 2px solid var(--primary-blue);
        }

        .btn-secondary:hover {
            background: var(--secondary-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 116, 193, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-green) 0%, #218838 100%);
      color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.25);
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.35);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-red) 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.35);
        }

        .btn-outline {
            background: white;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .btn-outline:hover {
            background: var(--bg-light);
            color: var(--primary-blue);
            border-color: var(--primary-blue);
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        .btn-sm {
            padding: 0.55rem 1.1rem;
            font-size: 0.875rem;
        }

        .btn-lg {
            padding: 1rem 2rem;
            font-size: 1.05rem;
            font-weight: 600;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn:active {
            transform: translateY(0) !important;
        }

        /* Empty States - Modern Design */
        .empty-state {
            text-align: center;
            padding: 4.5rem 2rem;
            color: var(--text-secondary);
            background: linear-gradient(to bottom, #fafbfc, #ffffff);
            border-radius: 12px;
            margin: 1rem;
        }

        .empty-state-icon {
            font-size: 4.5rem;
            margin-bottom: 1.25rem;
            opacity: 0.4;
            filter: grayscale(20%);
        }

        .empty-state h3 {
            font-size: 1.4rem;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            font-weight: 600;
            letter-spacing: -0.01em;
        }

        .empty-state p {
            margin-bottom: 1.75rem;
            font-size: 1rem;
            line-height: 1.6;
            max-width: 480px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2100;
            animation: fadeIn 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 24px 64px rgba(0,0,0,0.16);
            animation: slideUp 0.3s ease;
            border: 1px solid rgba(0,0,0,0.05);
        }

        .modal-header {
            padding: 2rem 2.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            letter-spacing: -0.01em;
        }

        .modal-title i {
            color: var(--primary-blue);
            font-size: 1.3rem;
        }

        .modal-close {
            background: none;
      border: none;
            font-size: 1.5rem;
      cursor: pointer;
            color: var(--text-secondary);
            width: 36px;
            height: 36px;
      display: flex;
      align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-light);
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        .modal-body {
            padding: 2rem 2.5rem;
            max-height: calc(90vh - 180px);
            overflow-y: auto;
        }

        .modal-footer {
            padding: 1.5rem 2.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            background: linear-gradient(to top, #ffffff, #fafbfc);
        }

        /* Forms - Modern Input Design */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            letter-spacing: 0.01em;
        }

        .form-input,
        .form-textarea,
        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
      background: white;
            font-family: inherit;
            height: 44px;
        }

        .form-textarea {
            height: auto;
            min-height: 120px;
        }

        .form-input:hover,
        .form-textarea:hover,
        .form-select:hover {
            border-color: #b8c5d0;
        }

        .form-input:focus,
        .form-textarea:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 4px rgba(0, 116, 193, 0.1);
            background: white;
        }

        .form-textarea {
            resize: vertical;
            line-height: 1.6;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236c757d' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2.5rem;
        }

        /* Wizard */
        .wizard {
            position: fixed;
            inset: 0;
            background: var(--bg-page);
            z-index: 2000;
            display: none;
            /* Full-screen, scroll-free shell */
            display: none;
        }

        .wizard.active {
            /* Use flex grid to allocate space without page scroll */
      display: grid;
            grid-template-rows: auto 1fr auto; /* header, content, footer */
            height: 100vh;
            width: 100vw;
            overflow: hidden; /* no page scroll */
        }

        .wizard-header {
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
            padding: 2rem 3rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Agent Cards - Modern Design */
        .agent-card {
            transition: all 0.3s ease;
            position: relative;
            background: white;
            border-radius: 12px;
        }

        .agent-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 116, 193, 0.18) !important;
            border-color: var(--primary-blue) !important;
        }

        .agent-card.selected {
            background: linear-gradient(135deg, var(--secondary-blue), #f0f8ff) !important;
            border-color: var(--primary-blue) !important;
            box-shadow: 0 8px 28px rgba(0, 116, 193, 0.25) !important;
        }

        .agent-card.selected::before {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
      display: flex;
      align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            box-shadow: 0 2px 8px rgba(0, 116, 193, 0.4);
            z-index: 10;
        }

        .wizard-steps {
            /* Even spacing between two steps with a clear center line */
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
            margin-top: 1rem;
            max-width: 520px; /* keeps steps tight and aligned */
            width: 100%;
        }

        .wizard-step {
      display: flex;
      flex-direction: column;
      align-items: center;
            gap: 0.75rem;
            color: #b0b8c1;
            position: relative;
        }

        .wizard-step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f5f7fa;
            border: 2px solid #d4dae0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1rem;
            color: #b0b8c1;
            transition: all 0.3s ease;
        }

        .wizard-step span {
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .wizard-step.active {
            color: var(--primary-blue);
        }

        .wizard-step.active .wizard-step-number {
            background: var(--primary-blue);
      color: white;
            border-color: var(--primary-blue);
            box-shadow: 0 4px 12px rgba(0, 116, 193, 0.3);
        }

        .wizard-step.completed .wizard-step-number {
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }

        /* Connecting Lines Between Steps */
        .wizard-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 20px;
            left: calc(100% + 20px);
            width: 48px;
            height: 2px;
            background: #e5e7eb; /* neutral-200 */
            z-index: -1;
        }

        .wizard-step.completed:not(:last-child)::after {
            background: #27ae60;
        }

        .wizard-content {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto; /* remove vertical margins to avoid scroll */
            padding: 1rem 3rem 1rem; /* compact spacing */
            overflow: auto; /* allow inner scroll if needed on smaller screens */
            min-height: 0; /* prevents flex overflow */
        }
        
        @media (max-width: 1300px) {
            .wizard-content { padding: 0.75rem 2rem; }
        }

        .wizard-footer {
            background: linear-gradient(to top, #ffffff, #fafbfc);
            padding: 1.25rem 3rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
      align-items: center;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.06);
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        /* Two Column Layout - Modern Design */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.75rem;
        }

        .column {
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 1.75rem;
            min-height: 320px;
            background: linear-gradient(to bottom, #ffffff, #fafbfc);
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            transition: all 0.3s ease;
        }

        .column:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
        }

        .column-header {
            font-weight: 600;
            margin-bottom: 1.25rem;
            color: var(--text-primary);
            font-size: 1.05rem;
            letter-spacing: -0.01em;
        }

        /* List Items - Modern Card Style */
        .list-item {
            background: white;
            padding: 1.25rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
      align-items: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }

        .list-item:hover {
            background: #fafbfd;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: var(--primary-blue);
        }

        .list-item.selectable {
            cursor: pointer;
        }

        .list-item.selected {
            background: var(--secondary-blue);
            border: 2px solid var(--primary-blue);
            box-shadow: 0 4px 16px rgba(0, 116, 193, 0.2);
        }

        /* Tags/Badges - Pill-shaped (Adobe XD Theme) */
        .tag {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .tag-ai {
            background: #e8daef;
            color: #6c3483;
        }

        .tag-new {
            background: #d4edda;
            color: #155724;
        }

        .tag-human {
            background: #d5f4e6;
            color: #0b5345;
        }

        .tag-submitted {
            background: #fcf3cf;
            color: #856404;
        }

        .tag-draft {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        /* Legacy support */
        .tag-pending {
            background: #fcf3cf;
            color: #856404;
        }

        .tag-active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tag-completed {
            background: #d4edda;
            color: #155724;
        }

        .tag-submitted {
            background: #d4edda;
            color: #155724;
        }

        .tag-draft {
            background: #e2e3e5;
            color: #383d41;
        }

        /* Project Cards - Modern Card Design */
        .project-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 1.5rem;
        }

        .project-card {
            background: linear-gradient(to bottom right, #ffffff, #fafbfc);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
            overflow: hidden;
    }

        .project-card::before {
            content: '';
      position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-blue), var(--primary-dark));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .project-card:hover {
            border-color: var(--primary-blue);
            box-shadow: 0 8px 24px rgba(0, 116, 193, 0.15);
            transform: translateY(-4px);
        }

        .project-card:hover::before {
            opacity: 1;
        }

        .project-card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.6rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.01em;
        }

        .project-card-meta {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .project-card-meta i {
            font-size: 0.9rem;
        }

        /* Tables - Modern Design */
        .data-table {
      width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: var(--bg-white);
            border-radius: 0;
        }

        .data-table thead {
            background: linear-gradient(to bottom, #fafbfc, #f4f6f8);
            border-bottom: 2px solid var(--border-color);
        }

        .data-table th {
            padding: 1.25rem 1.75rem;
      text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-primary);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .data-table td {
            padding: 1.5rem 1.75rem;
            border-bottom: 1px solid #f0f2f5;
            font-size: 0.95rem;
            color: var(--text-secondary);
            vertical-align: middle;
        }

        .data-table td a {
            white-space: nowrap;
        }

        .data-table td:first-child,
        .data-table th:first-child {
            padding-left: 2rem;
        }

        .data-table td:last-child,
        .data-table th:last-child {
            padding-right: 2rem;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
        }

        .data-table tbody tr:hover {
            background: linear-gradient(to right, #fafbfd, #ffffff);
            box-shadow: inset 3px 0 0 var(--primary-blue);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table .action-icons {
      display: flex;
            gap: 0.85rem;
            align-items: center;
            justify-content: center;
        }

        .data-table .action-icons i {
            color: var(--primary-blue);
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s;
            padding: 0.4rem;
            border-radius: 6px;
        }

        .data-table .action-icons i:hover {
            color: var(--primary-dark);
            background: var(--secondary-blue);
            transform: scale(1.1);
        }

        /* Table Controls */
        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-controls-left {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex: 1;
        }

        .table-controls-right {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Search and Action Bar - Modern Layout */
        .search-action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .search-action-bar .form-input {
            flex: 1;
            max-width: 450px;
            margin: 0;
        }

        /* Toast Notifications - Modern Design */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
      background: white;
            padding: 1.15rem 1.75rem;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            display: none;
            align-items: center;
            gap: 1rem;
            z-index: 3000;
            animation: slideInRight 0.3s ease;
            border: 1px solid var(--border-color);
            min-width: 320px;
        }

        .toast.active {
      display: flex;
        }

        .toast.success {
            border-left: 4px solid var(--success-green);
            background: linear-gradient(to right, #f0fdf4, #ffffff);
        }

        .toast.error {
            border-left: 4px solid var(--danger-red);
            background: linear-gradient(to right, #fef2f2, #ffffff);
        }

        .toast.info {
            border-left: 4px solid var(--primary-blue);
            background: linear-gradient(to right, #eff6ff, #ffffff);
        }

        .toast::before {
            content: '';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            font-size: 1.2rem;
        }

        .toast.success::before {
            content: '\f058';
            color: var(--success-green);
        }

        .toast.error::before {
            content: '\f06a';
            color: var(--danger-red);
        }

        .toast.info::before {
            content: '\f05a';
            color: var(--primary-blue);
        }

        /* Page Transitions */
        .page-transition {
            animation: pageSlideIn 0.4s ease-out;
        }

        @keyframes pageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
      align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--bg-light);
            border-top-color: var(--primary-blue);
      border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-text {
            color: var(--text-primary);
            font-weight: 500;
            font-size: 1.1rem;
        }

        /* Progress Indicator */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: var(--bg-light);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-blue);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Checkmark Animation */
        .success-checkmark {
            width: 80px;
            height: 80px;
            margin: 0 auto 1rem;
        }

        .success-checkmark .check-icon {
            width: 80px;
            height: 80px;
            position: relative;
            border-radius: 50%;
            box-sizing: content-box;
            border: 4px solid var(--success-green);
            animation: scaleIn 0.4s ease-in-out;
        }

        .success-checkmark .check-icon::before {
            top: 3px;
            left: -2px;
            width: 30px;
            transform-origin: 100% 50%;
            border-radius: 100px 0 0 100px;
        }

        .success-checkmark .check-icon::after {
            top: 0;
            left: 30px;
            width: 60px;
            transform-origin: 0 50%;
            border-radius: 0 100px 100px 0;
            animation: rotateCircle 0.4s ease-in;
        }

        .success-checkmark .check-icon .icon-line {
            height: 5px;
            background-color: var(--success-green);
            display: block;
            border-radius: 2px;
            position: absolute;
            z-index: 10;
        }

        .success-checkmark .check-icon .icon-line.line-tip {
            top: 46px;
            left: 14px;
            width: 25px;
            transform: rotate(45deg);
            animation: iconLineTip 0.75s;
        }

        .success-checkmark .check-icon .icon-line.line-long {
            top: 38px;
            right: 8px;
            width: 47px;
            transform: rotate(-45deg);
            animation: iconLineLong 0.75s;
        }

        @keyframes scaleIn {
            0% { transform: scale(0); }
            100% { transform: scale(1); }
        }

        @keyframes iconLineTip {
            0% { width: 0; left: 1px; top: 19px; }
            54% { width: 0; left: 1px; top: 19px; }
            70% { width: 50px; left: -8px; top: 37px; }
            84% { width: 17px; left: 21px; top: 48px; }
            100% { width: 25px; left: 14px; top: 45px; }
        }

        @keyframes iconLineLong {
            0% { width: 0; right: 46px; top: 54px; }
            65% { width: 0; right: 46px; top: 54px; }
            84% { width: 55px; right: 0px; top: 35px; }
            100% { width: 47px; right: 8px; top: 38px; }
        }

        /* Voting Interface - Modern Design */
        .voting-card {
            background: linear-gradient(to bottom right, #ffffff, #fafbfc);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2.25rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .voting-card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .voting-card-header {
            margin-bottom: 1.75rem;
        }

        .voting-card-title {
            font-size: 1.35rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
            letter-spacing: -0.01em;
        }

        .voting-actions {
      display: flex;
            gap: 1.25rem;
      justify-content: center;
            margin-top: 2rem;
        }

        .vote-btn {
            padding: 1.15rem 2.5rem;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
      font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .vote-btn.up {
            background: linear-gradient(135deg, var(--success-green), #1e8449);
            color: white;
        }

        .vote-btn.up:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.35);
        }

        .vote-btn.down {
            background: linear-gradient(135deg, var(--danger-red), #a93226);
            color: white;
        }

        .vote-btn.down:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.35);
        }

        .vote-btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        /* Results Dashboard */
        .results-filter {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .results-list {
            list-style: none;
        }

        .result-item {
            background: white;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
      display: flex;
      justify-content: space-between;
            align-items: center;
        }

        .result-rank {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-blue);
            min-width: 60px;
        }

        .result-content {
            flex: 1;
            margin: 0 1.5rem;
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .result-scores {
            display: flex;
            gap: 2rem;
            min-width: 300px;
        }

        .score-item {
            text-align: center;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2c3e50;
        }

        .score-label {
            font-size: 0.85rem;
            color: #6c757d;
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-blue);
      border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 1300px) {
            .card {
                width: 100%;
            }
            
            .container {
                padding: 2rem 2.5rem;
            }

            /* Wizard two-column to single column */
            div[style*="grid-template-columns: 1fr 400px"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 1200px) {
            .agent-card {
                grid-column: span 1;
            }
            
            .container {
                padding: 2rem 2.5rem;
            }
            
            /* 3 columns to 2 columns on medium screens */
            .wizard-content [style*="grid-template-columns: repeat(3, 1fr)"] {
                grid-template-columns: repeat(2, 1fr) !important;
      }
    }

    @media (max-width: 768px) {
            .two-columns {
                grid-template-columns: 1fr;
            }

            .project-cards {
                grid-template-columns: 1fr;
            }

            .container {
                padding: 1.5rem 1.5rem;
            }

            .search-action-bar {
        flex-direction: column;
        align-items: stretch;
      }

            .search-action-bar .form-input {
                max-width: 100%;
            }

            /* Wizard responsive */
            div[style*="grid-template-columns: 1fr 400px"] {
                grid-template-columns: 1fr !important;
            }

            /* Step 3 form - stack fields vertically on mobile */
            div[style*="grid-template-columns: 1fr 1fr 1.5fr 2fr auto"] {
                grid-template-columns: 1fr !important;
            }

            .wizard-header {
                padding: 1.5rem 1.5rem;
            }

            .wizard-footer {
                padding: 1.25rem 1.5rem;
            }

            .wizard-content {
                padding: 0 1.5rem;
            }

            .nav-links {
                display: none;
            }

            .main-nav {
                padding: 0.75rem 1rem;
            }

            .sub-nav {
                padding: 0 1rem;
            }

            .sub-nav-tabs {
                overflow-x: auto;
                gap: 1rem;
            }

            .context-switcher-container {
        flex-direction: column;
                gap: 0.75rem;
      }

            .context-tab {
        width: 100%;
                justify-content: center;
            }

            /* Agent grid to 1 column on mobile */
            .wizard-content [style*="grid-template-columns: repeat(3, 1fr)"] {
                grid-template-columns: 1fr !important;
            }

            .wizard-content [style*="grid-template-columns: repeat(2, 1fr)"] {
                grid-template-columns: 1fr !important;
            }

            .metrics-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Checkbox List - Modern Design */
        .checkbox-list {
            list-style: none;
        }

        .checkbox-item {
            padding: 1.15rem 1.25rem;
            border-radius: 10px;
            margin-bottom: 0.85rem;
        display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .checkbox-item:hover {
            background: var(--secondary-blue);
            border-color: var(--primary-blue);
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(0, 116, 193, 0.15);
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-blue);
            border-radius: 4px;
        }

        .checkbox-item input[type="checkbox"]:checked {
            background: var(--primary-blue);
        }

        /* Info Box - Modern Design */
        .info-box {
            background: linear-gradient(to right, var(--secondary-blue), #f0f8ff);
            border-left: 4px solid var(--primary-blue);
            padding: 1.15rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.85rem;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(0, 116, 193, 0.08);
            border: 1px solid rgba(0, 116, 193, 0.15);
        }

        .info-box i {
            color: var(--primary-blue);
            font-size: 1.2rem;
        }

        .warning-box {
            background: linear-gradient(to right, #fffbeb, #fef3c7);
            border-left: 4px solid var(--warning-orange);
            padding: 1.15rem 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.85rem;
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.2);
        }

        .warning-box i {
            color: var(--warning-orange);
            font-size: 1.2rem;
        }

        /* Tabs - Modern Design */
        .tabs {
            display: flex;
            gap: 0;
            padding: 0 2.5rem;
            background: white;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            flex: 1;
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
        justify-content: center;
            gap: 0.5rem;
            border-radius: 8px 8px 0 0;
            position: relative;
            white-space: nowrap;
        }

        .tab i {
            font-size: 1.05rem;
        }

        .tab:hover {
            color: var(--text-primary);
            background: linear-gradient(to bottom, #fafbfc, transparent);
        }

        .tab.active {
            color: var(--primary-blue);
            border-bottom-color: var(--primary-blue);
            background: linear-gradient(to bottom, #fafbfc, transparent);
            font-weight: 600;
        }

        .tab.active::before {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-blue) 0%, var(--primary-dark) 100%);
            box-shadow: 0 2px 8px rgba(0, 116, 193, 0.3);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Footer */
        .footer {
            background: var(--bg-white);
            border-top: 1px solid var(--border-color);
            padding: 2.5rem 2rem 1.5rem;
            margin-top: auto;
        }

        .footer-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .footer-content {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .footer-logo-section {
            flex: 0 0 auto;
        }

        .footer-description {
            flex: 1;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.6;
            max-width: 700px;
        }

        .footer-nav {
            display: flex;
            gap: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .footer-nav a {
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: color 0.2s;
        }

        .footer-nav a:hover {
            color: var(--primary-blue);
        }

        .footer-copyright {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-align: center;
        }

        /* Scroll to Top Button - Modern Design */
        .scroll-to-top {
            position: fixed;
            bottom: 28px;
            right: 28px;
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            align-items: center;
        justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(0, 116, 193, 0.3);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .scroll-to-top:hover {
            transform: translateY(-4px) scale(1.1);
            box-shadow: 0 8px 24px rgba(0, 116, 193, 0.4);
        }

        .scroll-to-top:active {
            transform: translateY(-2px) scale(1.05);
        }

        .scroll-to-top i {
            font-size: 1.2rem;
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-secondary); }
        .text-primary { color: var(--primary-blue); }
        .fw-bold { font-weight: 600; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { justify-content: center; align-items: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .gap-3 { gap: 1.5rem; }
  </style>
</head>
<body>

    <!-- Main Navigation Header -->
    <nav class="main-nav">
        <div class="nav-container">
            <div class="nav-left">
                <a href="#" class="logo">
                    <div class="logo-icon"></div>
        <span>Challenges.one</span>
                </a>
                <ul class="nav-links">
                    <li><a href="#">The Challenges</a></li>
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle">The Changemakers</a>
                    </li>
                    <li><a href="#">Pricing</a></li>
                    <li><a href="#" class="active">Strategy Navigator</a></li>
                    <li><a href="#">Dashboard</a></li>
                </ul>
        </div>
            <div class="user-menu">
                <div class="user-avatar">E</div>
                <i class="fas fa-chevron-down user-avatar-dropdown"></i>
            </div>
        </div>
      </nav>

    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-container">
            <h1 class="welcome-greeting">Hello <span id="userName">emerson</span></h1>
            <p class="welcome-date" id="currentDate">Nov 9, 2025</p>
      </div>
    </div>

    <!-- Sub Navigation - Module Tabs -->
    <div class="sub-nav">
        <div class="sub-nav-container">
            <div class="sub-nav-tabs">
                <a href="#" class="sub-nav-tab" data-tab="overview">Overview</a>
                <a href="#" class="sub-nav-tab" data-tab="challenges">Challenges</a>
                <a href="#" class="sub-nav-tab" data-tab="participation">Participation</a>
                <a href="#" class="sub-nav-tab" data-tab="evaluation">Evaluation</a>
                <a href="#" class="sub-nav-tab" data-tab="rewards">Rewards</a>
                <a href="#" class="sub-nav-tab" data-tab="qa">Q&A</a>
                <a href="#" class="sub-nav-tab active" data-tab="strategy">Strategy Navigator
                    <span class="notification-dot hidden" id="assignmentNotification"></span>
                </a>
            </div>
            <button class="btn btn-primary">
                Request a Challenge <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Context Switcher Removed - Using Tabs Instead -->

    <!-- Metrics Section - Only show when in My Workspace context -->
    <!-- Metrics Section Removed -->

    <!-- Breadcrumbs -->
    <div class="breadcrumbs" id="breadcrumbs"></div>

    <!-- Main Container -->
    <div class="container" id="mainContainer"></div>

    <!-- Modal Overlay -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal" id="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle"></h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter"></div>
        </div>
    </div>

    <!-- Wizard -->
    <div class="wizard" id="wizard">
        <div class="wizard-header">
            <h2 id="wizardTitle">Create New Project</h2>
            <div class="wizard-steps" id="wizardSteps"></div>
        </div>
        <div class="wizard-content" id="wizardContent"></div>
        <div class="wizard-footer" id="wizardFooter"></div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span id="toastMessage"></span>
      </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Loading...</div>
        </div>
      </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-content">
                <div class="footer-logo-section">
                    <a href="#" class="logo">
                        <div class="logo-icon"></div>
        <span>Challenges.one</span>
                    </a>
      </div>
                <div class="footer-description">
                    Challenges.one is a social impact-driven open innovation platform that harnesses collective intelligence to create meaningful change in people's lives. With a mission to positively impact at least 100,000 lives through each challenge featured on the platform, it empowers participants to think strategically about future solutions while making a tangible difference.
                </div>
            </div>
            <nav class="footer-nav">
                <a href="#">About Us</a>
                <a href="#">Contact Us</a>
                <a href="#">Terms & Conditions</a>
                <a href="#">Privacy Policy</a>
      </nav>
            <div class="footer-copyright">
                Multiverz &copy; 2025
      </div>
    </div>
    </footer>

    <!-- Scroll to Top Button -->
    <button class="scroll-to-top" onclick="window.scrollTo({ top: 0, behavior: 'smooth' })">
        <i class="fas fa-chevron-up"></i>
    </button>

    <script>
        // State Management
        const state = {
            currentUser: {
                id: 1,
                name: 'User A',
                email: 'usera@example.com',
                role: 'owner',
                hasLicenses: true,
                licenses: 25,
                aiAgents: 25
            },
            projects: [],
            draftProjects: [],
            purchaseHistory: [
                // Example data – can be empty. Each record increases licensed slots.
                // { date: '2025-11-10', package: 'Professional', quantity: 3, amount: 150 }
            ],
            currentView: 'workspace',
            currentPage: 'dashboard',
            currentProject: null,
            currentVotingSession: null,
            wizardStep: 1,
            wizardData: {},
            aiRoster: [
                { id: 1, name: 'Alex Carter', description: 'Questions what everyone else assumes is true. Finds risks hiding in plain sight. Reveals opportunities others overlook.', role: 'Contrarian Thinker', deployed: false },
                { id: 2, name: 'Alexander Petrov', description: 'Invents new ways to create and capture value. Shows how to make ideas financially viable. Designs platforms that grow exponentially.', role: 'Business Models Strategist', deployed: false },
                { id: 3, name: 'Ayu Laksmi', description: 'Designs around how people really decide. Makes good choices feel easy and natural. Creates incentives that actually work.', role: 'Behavioral Economics Expert', deployed: false },
                { id: 4, name: 'Chen Wei', description: 'Shows how everything connects to everything. Finds small moves with huge impact. Predicts ripple effects others miss.', role: 'Systems Complexity Advisor', deployed: false },
                { id: 5, name: 'Diego Morales', description: 'Finds opportunities others completely miss. Creates new markets instead of competing. Turns breakthrough ideas into real products.', role: 'Global Innovation Director', deployed: false },
                { id: 6, name: 'Fatima Al-Hassan', description: 'Finds what actually works across countries. Adapts global successes to local realities. Reveals why some approaches succeed.', role: 'International Best Practices Expert', deployed: false },
                { id: 7, name: 'Hiro Tanaka', description: 'Mines science fiction for real solutions. Builds working prototypes from bold ideas. Tests radical concepts through storytelling.', role: 'Science Fiction Scholar', deployed: false },
                { id: 8, name: 'Lars Nyström', description: 'Plans for multiple possible futures at once. Shows when to act as situations unfold. Prepares you for surprising changes.', role: 'Strategic Scenarios Expert', deployed: false },
                { id: 9, name: 'Mariam Okoye', description: 'Spots major shifts before others see them. Turns 30-year visions into quarterly plans. Maps how today\'s choices shape tomorrow.', role: 'Global Futures Strategist', deployed: false },
                { id: 10, name: 'Omar Khan', description: 'Unlocks funding for ambitious projects. Structures deals that attract investors. Makes development goals financially viable.', role: 'Global Finance Strategist', deployed: false },
                { id: 11, name: 'Park Mi-kyung', description: 'Turns big ideas into step-by-step plans. Shows exactly who does what and when. Scales solutions while keeping quality.', role: 'Implementation Specialist', deployed: false },
                { id: 12, name: 'Priya Ramanathan', description: 'Designs AI that amplifies human capabilities. Spots AI hype vs real opportunities. Maps practical automation roadmaps.', role: 'AI Transformation Advisor', deployed: false },
                { id: 13, name: 'Robert Whitaker', description: 'Ensures solutions benefit everyone fairly. Spots and fixes bias before it causes harm. Designs equity in from the start.', role: 'Ethics and Equity Advisor', deployed: false },
                { id: 14, name: 'Sophie Dubois', description: 'Catches emerging changes years early. Spots patterns before they become trends. Tells you when to move first.', role: 'Weak Signals Analyst', deployed: false },
                { id: 15, name: 'Zuri Kamau', description: 'Builds systems that get stronger from shocks. Spots vulnerabilities before they hurt you. Designs plans that survive disruption.', role: 'Risk and Resilience Advisor', deployed: false },
                { id: 16, name: 'Climate Tech Specialist', description: 'Analyzes carbon reduction technologies and renewable solutions', role: 'Environmental Tech', deployed: false },
                { id: 17, name: 'Industry Domain Expert', description: 'Provides industry-specific insights and best practices', role: 'Sector Specialist', deployed: false },
                { id: 18, name: 'Regional Market Advisor', description: 'Analyzes regional market conditions and cultural factors', role: 'Geographic Expert', deployed: false }
            ],
            teamMembers: [
                { id: 2, name: 'Sarah Johnson', email: 'sarah.johnson@example.com', status: 'active', joinedDate: '2024-12-15' },
                { id: 3, name: 'Michael Chen', email: 'michael.chen@example.com', status: 'active', joinedDate: '2024-12-18' },
                { id: 4, name: 'Emily Rodriguez', email: 'emily.rodriguez@example.com', status: 'active', joinedDate: '2024-12-20' },
                { id: 5, name: 'David Kim', email: 'david.kim@example.com', status: 'pending', joinedDate: null },
                { id: 6, name: 'Lisa Anderson', email: 'lisa.anderson@example.com', status: 'active', joinedDate: '2025-01-02' },
                { id: 7, name: 'James Wilson', email: 'james.wilson@example.com', status: 'active', joinedDate: '2025-01-05' },
                { id: 8, name: 'Maria Garcia', email: 'maria.garcia@example.com', status: 'pending', joinedDate: null },
                { id: 9, name: 'Robert Taylor', email: 'robert.taylor@example.com', status: 'active', joinedDate: '2025-01-08' }
            ],
            notifications: [],
            dashboardSort: { column: null, direction: null }, // column: 'name'|'created'|'category'|'status'|'agents'|'ideas'
        };

        function getAvailableProjectSlots() {
            const purchased = state.purchaseHistory.reduce((sum, tx) => sum + (tx.quantity || 0), 0);
            const activeProjects = state.projects.length;
            const available = Math.max(0, purchased - activeProjects);
            return available;
        }

        // Routing & Navigation with smooth transitions
        function navigateTo(view, page = 'dashboard', data = null) {
            // Show loading for a smooth transition
            showLoading('Loading...');
            
            // Simulate async operation for smooth UX
            setTimeout(() => {
                state.currentView = view;
                state.currentPage = page;
                
                // Update context tabs
                document.querySelectorAll('.context-tab').forEach(tab => {
                    tab.classList.remove('active');
                    if (tab.dataset.context === view) {
                        tab.classList.add('active');
                    }
                });

                // Update breadcrumbs
                updateBreadcrumbs();

                // Scroll to top smoothly
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Render the page (this handles metrics visibility)
                render();
                
                // Hide loading and add page transition
                hideLoading();
                const container = document.getElementById('mainContainer');
                if (container) {
                    container.classList.add('page-transition');
                    setTimeout(() => container.classList.remove('page-transition'), 400);
                }
            }, 300);
        }

        // Context Switcher - The Dual Hat Toggle
        function switchContext(context) {
            if (context === state.currentView) return; // Already in this context
            
            showLoading(context === 'workspace' ? 'Switching to Owner view...' : 'Switching to Participant view...');
            
            setTimeout(() => {
                // Navigate directly to relevant page for each context
                if (context === 'workspace') {
                    navigateTo('workspace', 'dashboard'); // This will show My Projects directly
                } else {
                    navigateTo('assignments', 'dashboard');
                }
                
                // Show helpful toast
                const message = context === 'workspace' 
                    ? '👔 You are now in Owner mode - Manage your projects' 
                    : '✋ You are now in Participant mode - Contribute to projects';
                showToast(message, 'info');
            }, 400);
        }

        function updateBreadcrumbs() {
            const breadcrumbs = document.getElementById('breadcrumbs');
            let crumbs = [];

            // Build breadcrumb trail based on current location
            if (state.currentView === 'workspace') {
                // My Workspace dashboard = My Projects, so no breadcrumb needed there
                if (state.currentPage === 'project-detail' && state.currentProject) {
                    crumbs.push('<a onclick="navigateTo(\'workspace\', \'dashboard\')">My Workspace</a>');
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<span>${state.currentProject.name}</span>`);
                } else if (state.currentPage === 'voting-sessions' && state.currentProject) {
                    crumbs.push('<a onclick="navigateTo(\'workspace\', \'dashboard\')">My Workspace</a>');
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<a onclick="viewProject(${state.currentProject.id})">${state.currentProject.name}</a>`);
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push('<span>Voting Sessions</span>');
                } else if (state.currentPage === 'voting-results' && state.currentProject && state.currentVotingSession) {
                    crumbs.push('<a onclick="navigateTo(\'workspace\', \'dashboard\')">My Workspace</a>');
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<a onclick="viewProject(${state.currentProject.id})">${state.currentProject.name}</a>`);
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<a onclick="viewProjectVotingSessions(${state.currentProject.id})">Voting Sessions</a>`);
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<span>${state.currentVotingSession.name} Results</span>`);
                }
            } else if (state.currentView === 'assignments') {
                // My Assignments dashboard = top level, no breadcrumb
                if (state.currentPage === 'assignment-detail' && state.currentProject) {
                    crumbs.push('<a onclick="navigateTo(\'assignments\', \'dashboard\')">My Assignments</a>');
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<span>${state.currentProject.name}</span>`);
                } else if (state.currentPage === 'voting' && state.currentProject && state.currentVotingSession) {
                    crumbs.push('<a onclick="navigateTo(\'assignments\', \'dashboard\')">My Assignments</a>');
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<a onclick="viewAssignment(${state.currentProject.id})">${state.currentProject.name}</a>`);
                    crumbs.push('<span>&gt;</span>');
                    crumbs.push(`<span>${state.currentVotingSession.name}</span>`);
                }
            }

            if (crumbs.length > 0) {
                breadcrumbs.innerHTML = '<div class="breadcrumbs-container">' + crumbs.join(' ') + '</div>';
                breadcrumbs.style.display = 'block';
            } else {
                breadcrumbs.style.display = 'none';
            }
        }

        // Navigation helper for voting sessions tab
        function viewProjectVotingSessions(projectId) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            navigateTo('workspace', 'voting-sessions');
        }

        // Set current date
        function setCurrentDate() {
            const dateElement = document.getElementById('currentDate');
            const now = new Date();
            const options = { year: 'numeric', month: 'short', day: 'numeric' };
            dateElement.textContent = now.toLocaleDateString('en-US', options);
        }

        // Render Functions
        function render() {
            const container = document.getElementById('mainContainer');

            switch (state.currentView) {
                case 'workspace':
                    if (state.currentPage === 'dashboard') {
                        renderWorkspaceDashboard(container);
                    } else if (state.currentPage === 'projects') {
                        renderProjects(container);
                    } else if (state.currentPage === 'project-detail') {
                        renderProjectDetail(container);
                    } else if (state.currentPage === 'voting-results') {
                        renderVotingResults(container);
                    } else if (state.currentPage === 'voting-sessions') {
                        renderVotingSessionsPage(container);
                    }
                    break;
                case 'assignments':
                    if (state.currentPage === 'dashboard') {
                        renderAssignmentsDashboard(container);
                    } else if (state.currentPage === 'assignment-detail') {
                        renderAssignmentDetail(container);
                    } else if (state.currentPage === 'voting') {
                        renderVoting(container);
                    }
                    break;
            }
        }

        function renderVotingSessionsPage(container) {
            const project = state.currentProject;
            
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="title-bar"></span>
                            Voting Sessions - ${project.name}
                        </h2>
                        <button class="btn btn-primary" onclick="startVotingWizard()">
                            <i class="fas fa-plus"></i> New Voting Session
                        </button>
    </div>
                    ${renderVotingSessionsTab(project)}
                </div>
            `;
        }

        function renderWorkspaceDashboard(container) {
            if (!state.currentUser.hasLicenses) {
                // Upsell page - user needs to purchase licenses first
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-state-icon">🚀</div>
                            <h3>Start Your Own Strategic Challenge</h3>
                            <p>Purchase licenses to create projects, assemble teams, and deploy AI agents to help solve your toughest strategic challenges.</p>
                            <button class="btn btn-primary" onclick="purchaseLicenses()">
                                <i class="fas fa-shopping-cart"></i> Buy Licenses Now
                            </button>
      </div>
      </div>
                `;
            } else {
                // Dashboard with Inventory tabs
                const tabs = state.dashboardTab || 'projects';
                const availableSlots = getAvailableProjectSlots();

                container.innerHTML = `
                    <div class="card">
                        <div class="card-header" style="justify-content: space-between; align-items: end;">
                            <div>
                                <h2 class="card-title" style="display: flex; align-items: center;">
                                    <span style="width: 4px; height: 2rem; background: var(--primary-blue); margin-right: 0.75rem; border-radius: 2px;"></span>
                                    Project Inventory
                                </h2>
                                <p class="text-muted" style="margin-top: 0.5rem; margin-left: 1.5rem;">Manage active projects, drafts, and available project slots.</p>
      </div>
      </div>
                        <div class="tabs" style="padding: 0 1.5rem;">
                            <div class="tab ${tabs==='projects'?'active':''}" onclick="state.dashboardTab='projects'; render();"><i class="fas fa-folder-open"></i> Projects</div>
                            <div class="tab ${tabs==='assignments'?'active':''}" onclick="state.dashboardTab='assignments'; render();"><i class="fas fa-tasks"></i> My Assignments</div>
                            <div class="tab ${tabs==='history'?'active':''}" onclick="state.dashboardTab='history'; render();"><i class="fas fa-receipt"></i> Purchase History</div>
    </div>

                        ${tabs==='projects' ? `
                        <div style="padding: 2.5rem;">
                            <!-- Search Bar -->
                            <div style="margin-bottom: 1rem; padding: 1rem 2rem;">
                                <input type="text" class="form-input" id="projectSearch" placeholder="🔍 Search projects by name or category..." onkeyup="filterProjects()" style="max-width: 450px;">
      </div>
                            
                            <div style="width:100%; padding: 0 1.5rem 1.5rem;">
                                <table class="data-table" id="projectTable" style="position:relative; width:100%;">
                                    <thead>
                                        <tr style="position:sticky; top:0; background:#f9fafb; z-index:1; border-bottom:1px solid var(--border-color);">
                                            <th style="width:5%; min-width:60px; white-space:nowrap;">Sr. No.</th>
                                            <th onclick="toggleProjectSort('name')" style="cursor:pointer; width:25%; white-space:nowrap; user-select:none;">
                                                <span style="display:inline-flex; align-items:center; gap:0.5rem;">
                                                    Project Name
                                                    <span style="display:inline-flex; align-items:center; color:#9ca3af; font-size:0.75rem;">${getSortIndicator('name')}</span>
                                                </span>
                                            </th>
                                            <th onclick="toggleProjectSort('purchase')" style="cursor:pointer; width:15%; min-width:150px; white-space:nowrap; user-select:none;">
                                                <span style="display:inline-flex; align-items:center; gap:0.5rem;">
                                                    Purchase Date
                                                    <span style="display:inline-flex; align-items:center; color:#9ca3af; font-size:0.75rem;">${getSortIndicator('purchase')}</span>
                                                </span>
                                            </th>
                                            <th onclick="toggleProjectSort('created')" style="cursor:pointer; width:15%; min-width:150px; white-space:nowrap; user-select:none;">
                                                <span style="display:inline-flex; align-items:center; gap:0.5rem;">
                                                    Created Date
                                                    <span style="display:inline-flex; align-items:center; color:#9ca3af; font-size:0.75rem;">${getSortIndicator('created')}</span>
                                                </span>
                                            </th>
                                            <th onclick="toggleProjectSort('status')" style="cursor:pointer; width:10%; min-width:100px; white-space:nowrap; user-select:none;">
                                                <span style="display:inline-flex; align-items:center; gap:0.5rem;">
                                                    Status
                                                    <span style="display:inline-flex; align-items:center; color:#9ca3af; font-size:0.75rem;">${getSortIndicator('status')}</span>
                                                </span>
                                            </th>
                                            <th onclick="toggleProjectSort('agents')" style="cursor:pointer; width:10%; min-width:100px; white-space:nowrap; user-select:none;">
                                                <span style="display:inline-flex; align-items:center; gap:0.5rem;">
                                                    Agents
                                                    <span style="display:inline-flex; align-items:center; color:#9ca3af; font-size:0.75rem;">${getSortIndicator('agents')}</span>
                                                </span>
                                            </th>
                                            <th style="width:10%; min-width:120px; white-space:nowrap; text-align:center;">Actions</th>
                                        </tr>
                                    </thead>
                                        <tbody>
                                         ${(() => {
                                             const rows = getInventoryData(availableSlots);
                                             const sorted = sortInventoryRows(rows);
                                             return sorted.map((item, idx) => renderInventoryRow(item, idx)).join('');
                                         })()}
                                        </tbody>
                                    </table>
    </div>
                        </div>
                        ` : tabs==='assignments' ? `
                        <div class="content-spacing">
                            <h3 style='display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;'><i class="fas fa-tasks"></i> My Assignments (${state.projects.filter(p => p.humanTeam.some(m => m.id === state.currentUser.id)).length})</h3>
                            <p class="text-muted" style="margin-bottom: 1.5rem;">Projects you've been invited to contribute to</p>
                            ${state.projects.filter(p => p.humanTeam.some(m => m.id === state.currentUser.id)).length === 0 ? `
                                <div class='empty-state'>
                                    <div class='empty-state-icon'>📋</div>
                                    <h3>No Assignments Yet</h3>
                                    <p>You haven't been invited to any projects yet. Check back later!</p>
                                </div>
                            ` : `
                                <div style='display:grid;gap:1rem;'>
                                    ${state.projects.filter(p => p.humanTeam.some(m => m.id === state.currentUser.id)).map(p=>`
                                        <div class='list-item' onclick='viewProject(${p.id})' style='cursor:pointer;'>
                                            <div style='flex:1;'>
                                                <strong style='font-size:1.05rem;'>${p.name}</strong>
                                                <p class='text-muted' style='margin:0.25rem 0 0;'>${p.description.substring(0,120)}...</p>
                                                <div style='margin-top:0.5rem;display:flex;gap:1rem;font-size:0.9rem;color:var(--text-secondary);'>
                                                    <span><i class='fas fa-lightbulb'></i> ${p.ideas?.length || 0} ideas</span>
                                                    <span><i class='fas fa-vote-yea'></i> ${p.votingSessions?.filter(v => v.status==='active').length || 0} active votes</span>
                                                </div>
                                            </div>
                                            <button class='btn btn-primary' onclick='event.stopPropagation();viewProject(${p.id})'>
                                                <i class='fas fa-arrow-right'></i> View Project
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        ` : `
                        <div class="content-spacing">
                            <h3 style='display:flex;align-items:center;gap:.5rem;margin-bottom:.75rem;'><i class="fas fa-receipt"></i> Purchase History (${state.purchaseHistory.length})</h3>
                            ${state.purchaseHistory.length===0 ? `<div class='empty-state'><div class='empty-state-icon'>🧾</div><h3>No Purchases Yet</h3></div>` : `
                                <table class='data-table'>
                                    <thead><tr><th>Purchase Date</th><th>License Package</th><th>No. of Project licenses</th><th>Amount</th></tr></thead>
          <tbody>
                                        ${state.purchaseHistory.map(tx=>`
                                            <tr>
                                                <td>${tx.date}</td>
                                                <td>${tx.package || 'Professional'}</td>
                                                <td>${tx.quantity}</td>
                                                <td>$${(tx.amount|| (tx.quantity*50)).toFixed(2)}</td>
            </tr>
                                        `).join('')}
          </tbody>
                                </table>`}
      </div>
                        `}
                    </div>
                `;
            }
        }

        function resumeDraft(idx){
            const draft = state.draftProjects[idx];
            state.wizardData = {...draft};
            state.wizardStep = draft.selectedAI ? 2 : 1;
            document.getElementById('wizard').classList.add('active');
            renderWizard();
        }

        function startProjectWizardFromSlot(){
            // Do not consume slot yet; we just open wizard
            startProjectWizard();
        }

        function viewProjectAgents(projectId) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            state.projectActiveTab = 'agents';
            navigateTo('workspace', 'project-detail');
        }

        function viewProjectIdeas(projectId) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            state.projectActiveTab = 'ideas';
            navigateTo('workspace', 'project-detail');
        }

        function filterProjects() {
            const searchTerm = document.getElementById('projectSearch')?.value.toLowerCase() || '';
            const table = document.getElementById('projectTable');
            if (!table) return;
            
            const rows = table.querySelectorAll('tbody tr');
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        function editProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            showModal(
                '<i class="fas fa-edit"></i> Edit Project',
                `
                    <form id="editProjectForm">
                        <div class="form-group">
                            <label class="form-label">Project Name *</label>
                            <input type="text" class="form-input" id="editProjectName" value="${project.name}" required>
      </div>
                        <div class="form-group">
                            <label class="form-label">Project Category *</label>
                            <input type="text" class="form-input" id="editProjectCategory" value="${project.category}" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Project Timeline *</label>
                            <select class="form-select" id="editProjectTimeline" required>
                                <option value="0-2y" ${project.timeline==='0-2y'?'selected':''}>0 to 2 Years</option>
                                <option value="2-5y" ${project.timeline==='2-5y'?'selected':''}>2 to 5 Years</option>
                                <option value="5-10y" ${project.timeline==='5-10y'?'selected':''}>5 to 10 Years</option>
                                <option value="other" ${project.timeline==='other'?'selected':''}>Other</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Project Description *</label>
                            <textarea class="form-textarea" id="editProjectDescription" required>${project.description}</textarea>
                        </div>
                    </form>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveProjectEdit(${projectId})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                `
            );
        }

        function saveProjectEdit(projectId) {
            const name = document.getElementById('editProjectName').value.trim();
            const category = document.getElementById('editProjectCategory').value.trim();
            const timeline = document.getElementById('editProjectTimeline').value;
            const description = document.getElementById('editProjectDescription').value.trim();
            
            if (!name || !category || !timeline || !description) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            const project = state.projects.find(p => p.id === projectId);
            project.name = name;
            project.category = category;
            project.timeline = timeline;
            project.description = description;
            
            closeModal();
            showToast('✓ Project updated successfully', 'success');
            render();
        }

        function deleteProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            
            showModal(
                '<i class="fas fa-exclamation-triangle" style="color:var(--danger-red);"></i> Delete Project',
                `
                    <div class="warning-box" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> This will permanently delete the project and all associated data (${project.ideas?.length || 0} ideas, ${project.votingSessions?.length || 0} voting sessions).
      </div>
                    <p style="margin-bottom: 1rem;">Are you sure you want to delete this project?</p>
                    <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 8px; border-left: 3px solid var(--danger-red);">
                        <strong style="font-size: 1.1rem;">${project.name}</strong>
                        <p class="text-muted" style="margin: 0.5rem 0 0 0;">${project.category} • ${project.timeline}</p>
                    </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDeleteProject(${projectId})">
                        <i class="fas fa-trash"></i> Yes, Delete Project
                    </button>
                `
            );
        }

        function confirmDeleteProject(projectId) {
            closeModal();
            showLoading('Deleting project...');
            
            setTimeout(() => {
                state.projects = state.projects.filter(p => p.id !== projectId);
                hideLoading();
                showToast('✓ Project deleted successfully', 'success');
                navigateTo('workspace', 'dashboard');
            }, 500);
        }

        function filterIdeas() {
            const searchTerm = document.getElementById('ideaSearch')?.value.toLowerCase() || '';
            const container = document.getElementById('ideasContainer');
            if (!container) return;
            
            const ideaRows = container.querySelectorAll('div[style*="display: flex"]');
            ideaRows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function viewUserDetails(projectId, userId) {
            const project = state.projects.find(p => p.id === projectId);
            const user = project.humanTeam.find(u => u.id === userId);
            
            showModal(
                '<i class="fas fa-user"></i> User Details',
                `
                    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; border-radius: 12px; background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 2rem; flex-shrink: 0;">
                            ${user.name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2)}
                        </div>
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.4rem;">${user.name}</h3>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.95rem;"><i class="fas fa-envelope"></i> ${user.email}</p>
                        </div>
                    </div>
                    
                    <div style="display: grid; gap: 1rem;">
                        <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Status</div>
                            <span class="tag ${user.status === 'active' ? 'tag-draft' : 'tag-submitted'}">${user.status === 'active' ? 'Draft' : 'Submitted'}</span>
                        </div>
                        <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Project</div>
                            <strong>${project.name}</strong>
                        </div>
                        <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Joined Date</div>
                            <strong>${user.joinedDate ? new Date(user.joinedDate).toLocaleDateString() : 'Pending'}</strong>
                        </div>
                    </div>
                `,
                `<button class="btn btn-primary" onclick="closeModal()">Close</button>`
            );
        }

        function viewAIAgentDetails(projectId, agentId) {
            const project = state.projects.find(p => p.id === projectId);
            const agent = project.aiTeam.find(a => a.id === agentId);
            
            showModal(
                '<i class="fas fa-robot"></i> AI Agent Details',
                `
                    <div style="display: flex; align-items: center; gap: 1.5rem; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; border-radius: 12px; background: linear-gradient(135deg, #8a2be2, #6a1bb2); color: white; display: flex; align-items: center; justify-content: center; font-size: 2.5rem; flex-shrink: 0;">
                            🤖
                        </div>
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0; font-size: 1.4rem;">${agent.name}</h3>
                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.95rem;">${agent.role}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="font-size: 1.05rem; margin-bottom: 0.75rem; color: var(--text-primary);">Description</h4>
                        <p style="color: var(--text-secondary); line-height: 1.6;">${agent.description}</p>
                    </div>
                    
                    <div style="background: var(--bg-light); padding: 1.25rem; border-radius: 8px; border-left: 4px solid #8a2be2;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;">Deployed to</div>
                        <strong style="font-size: 1.05rem;">${project.name}</strong>
                        <p class="text-muted" style="margin: 0.5rem 0 0 0;">${project.category} • ${project.timeline}</p>
                    </div>
                    
                    <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <h4 style="font-size: 1.05rem; margin-bottom: 0.75rem; color: var(--text-primary);">Performance Metrics</h4>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                            <div style="text-align: center; padding: 1rem; background: var(--secondary-blue); border-radius: 8px;">
                                <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary-blue);">${project.ideas.filter(i => i.submittedBy === agent.name).length}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Ideas Generated</div>
                            </div>
                            <div style="text-align: center; padding: 1rem; background: var(--secondary-blue); border-radius: 8px;">
                                <div style="font-size: 1.8rem; font-weight: 700; color: var(--primary-blue);">${project.votingSessions.length}</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.25rem;">Voting Sessions</div>
                            </div>
                        </div>
                    </div>
                `,
                `<button class="btn btn-primary" onclick="closeModal()">Close</button>`
            );
        }

        function showAddUserToProjectModal(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            const availableUsers = state.teamMembers.filter(m => 
                !project.humanTeam.some(tm => tm.id === m.id)
            );

            if (availableUsers.length === 0) {
                showModal(
                    '<i class="fas fa-user-plus"></i> Add User to Project',
                    `
                        <div class="info-box">
                            <i class="fas fa-info-circle"></i> You don't have any available team members. Invite new participants first.
                        </div>
                        <div style="text-align: center; padding: 2rem;">
                            <button class="btn btn-primary" onclick="closeModal(); showInviteModal()">
                                <i class="fas fa-envelope"></i> Invite New Participant
                            </button>
                        </div>
                    `,
                    `<button class="btn btn-secondary" onclick="closeModal()">Close</button>`
                );
                return;
            }

            showModal(
                '<i class="fas fa-user-plus"></i> Add User to Project',
                `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <p class="text-muted" style="margin: 0;">Select team members to add to <strong>${project.name}</strong></p>
                        <button class="btn btn-outline btn-sm" onclick="closeModal(); setTimeout(() => showInviteModal(), 100);">
                            <i class="fas fa-envelope"></i> Invite New Participant
                        </button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${availableUsers.map(member => `
                            <label class="checkbox-item" style="margin-bottom: 0.75rem;">
                                <input type="checkbox" value="${member.id}" class="add-user-checkbox" style="width: 18px; height: 18px;">
                                <div style="flex: 1;">
                                    <strong style="display: block; font-size: 1rem;">${member.name}</strong>
                                    <span style="font-size: 0.9rem; color: var(--text-secondary);">${member.email}</span>
                                </div>
                                <span class="tag tag-${member.status === 'active' ? 'draft' : 'submitted'}">${member.status === 'active' ? 'Draft' : 'Submitted'}</span>
        </label>
                        `).join('')}
      </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addUsersToProject(${projectId})">
                        <i class="fas fa-check"></i> Add Selected Users
                    </button>
                `
            );
        }

        function addUsersToProject(projectId) {
            const selectedUsers = Array.from(document.querySelectorAll('.add-user-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedUsers.length === 0) {
                showToast('Please select at least one user', 'error');
                return;
            }

            const project = state.projects.find(p => p.id === projectId);
            
            selectedUsers.forEach(userId => {
                const user = state.teamMembers.find(m => m.id === userId);
                if (user && !project.humanTeam.some(tm => tm.id === userId)) {
                    project.humanTeam.push(user);
                }
            });

            closeModal();
            showToast(`✓ Added ${selectedUsers.length} user(s) to ${project.name}`, 'success');
            render();
        }

        function removeUserFromProject(projectId, userId) {
            if (!confirm('Are you sure you want to remove this user from the project? Their submitted ideas will be preserved.')) {
                return;
            }

            const project = state.projects.find(p => p.id === projectId);
            project.humanTeam = project.humanTeam.filter(m => m.id !== userId);
            
            showToast('User removed from project', 'success');
            render();
        }

        function showAddAIAgentToProjectModal(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            
            // Extended AI roster
            const fullAiRoster = [
                { id: 1, name: 'Alex Carter', role: 'Contrarian Thinker', description: 'Questions what everyone else assumes is true. Finds risks hiding in plain sight.' },
                { id: 2, name: 'Alexander Petrov', role: 'Business Models Strategist', description: 'Invents new ways to create and capture value. Shows how to make ideas financially viable.' },
                { id: 3, name: 'Ayu Laksmi', role: 'Behavioral Economics Expert', description: 'Designs around how people really decide. Makes good choices feel easy and natural.' },
                { id: 4, name: 'Chen Wei', role: 'Systems Complexity Advisor', description: 'Shows how everything connects to everything. Finds small moves with huge impact.' },
                { id: 5, name: 'Diego Morales', role: 'Global Innovation Director', description: 'Finds opportunities others completely miss. Creates new markets instead of competing.' },
                { id: 6, name: 'Fatima Al-Hassan', role: 'International Best Practices Expert', description: 'Finds what actually works across countries. Adapts global successes to local realities.' },
                { id: 7, name: 'Hiro Tanaka', role: 'Science Fiction Scholar', description: 'Mines science fiction for real solutions. Builds working prototypes from bold ideas.' },
                { id: 8, name: 'Lars Nyström', role: 'Strategic Scenarios Expert', description: 'Plans for multiple possible futures at once. Shows when to act as situations unfold.' },
                { id: 9, name: 'Mariam Okoye', role: 'Global Futures Strategist', description: 'Spots major shifts before others see them. Turns 30-year visions into quarterly plans.' },
                { id: 10, name: 'Omar Khan', role: 'Global Finance Strategist', description: 'Unlocks funding for ambitious projects. Structures deals that attract investors.' },
                { id: 11, name: 'Park Mi-kyung', role: 'Implementation Specialist', description: 'Turns big ideas into step-by-step plans. Shows exactly who does what and when.' },
                { id: 12, name: 'Priya Ramanathan', role: 'AI Transformation Advisor', description: 'Designs AI that amplifies human capabilities. Spots AI hype vs real opportunities.' },
                { id: 13, name: 'Robert Whitaker', role: 'Ethics and Equity Advisor', description: 'Ensures solutions benefit everyone fairly. Spots and fixes bias before it causes harm.' },
                { id: 14, name: 'Sophie Dubois', role: 'Weak Signals Analyst', description: 'Catches emerging changes years early. Spots patterns before they become trends.' },
                { id: 15, name: 'Zuri Kamau', role: 'Risk and Resilience Advisor', description: 'Builds systems that get stronger from shocks. Spots vulnerabilities before they hurt you.' }
            ];

            showModal(
                '<i class="fas fa-robot"></i> Add AI Agent to Project',
                `
                    <p class="text-muted" style="margin-bottom: 1.5rem;">Select AI agents to deploy to <strong>${project.name}</strong>. Already deployed agents are shown as selected.</p>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; max-height: 500px; overflow-y: auto;">
                        ${fullAiRoster.map(agent => {
                            const isSelected = project.aiTeam.some(ta => ta.id === agent.id);
                            return `
                            <label style="background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 8px; padding: 1rem; cursor: ${isSelected ? 'not-allowed' : 'pointer'}; transition: all 0.2s; display: flex; gap: 0.75rem; align-items: start; opacity: ${isSelected ? 0.6 : 1};">
                                <input type="checkbox" value="${agent.id}" ${isSelected ? 'checked disabled' : ''} class="${isSelected ? '' : 'add-agent-checkbox'}" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: ${isSelected ? 'not-allowed' : 'pointer'};">
                                <div style="flex: 1;">
                                    <strong style="display: block; font-size: 1rem; color: var(--text-primary); margin-bottom: 0.25rem;">${agent.name}</strong>
                                    <span style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${agent.role}</span>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">${agent.description}</p>
                                    ${isSelected ? '<span class="tag" style="margin-top:0.5rem;background:#e3f2fd;color:#1565c0;">Deployed</span>' : ''}
                                </div>
                            </label>`;
                        }).join('')}
                    </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addAIAgentsToProject(${projectId})">
                        <i class="fas fa-check"></i> Deploy Selected Agents
                    </button>
                `
            );
        }

        function addAIAgentsToProject(projectId) {
            const selectedAgents = Array.from(document.querySelectorAll('.add-agent-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedAgents.length === 0) {
                showToast('Please select at least one AI agent', 'error');
                return;
            }

            const fullAiRoster = [
                { id: 1, name: 'Alex Carter', role: 'Contrarian Thinker', description: 'Questions what everyone else assumes is true. Finds risks hiding in plain sight.' },
                { id: 2, name: 'Alexander Petrov', role: 'Business Models Strategist', description: 'Invents new ways to create and capture value. Shows how to make ideas financially viable.' },
                { id: 3, name: 'Ayu Laksmi', role: 'Behavioral Economics Expert', description: 'Designs around how people really decide. Makes good choices feel easy and natural.' },
                { id: 4, name: 'Chen Wei', role: 'Systems Complexity Advisor', description: 'Shows how everything connects to everything. Finds small moves with huge impact.' },
                { id: 5, name: 'Diego Morales', role: 'Global Innovation Director', description: 'Finds opportunities others completely miss. Creates new markets instead of competing.' },
                { id: 6, name: 'Fatima Al-Hassan', role: 'International Best Practices Expert', description: 'Finds what actually works across countries. Adapts global successes to local realities.' },
                { id: 7, name: 'Hiro Tanaka', role: 'Science Fiction Scholar', description: 'Mines science fiction for real solutions. Builds working prototypes from bold ideas.' },
                { id: 8, name: 'Lars Nyström', role: 'Strategic Scenarios Expert', description: 'Plans for multiple possible futures at once. Shows when to act as situations unfold.' },
                { id: 9, name: 'Mariam Okoye', role: 'Global Futures Strategist', description: 'Spots major shifts before others see them. Turns 30-year visions into quarterly plans.' },
                { id: 10, name: 'Omar Khan', role: 'Global Finance Strategist', description: 'Unlocks funding for ambitious projects. Structures deals that attract investors.' },
                { id: 11, name: 'Park Mi-kyung', role: 'Implementation Specialist', description: 'Turns big ideas into step-by-step plans. Shows exactly who does what and when.' },
                { id: 12, name: 'Priya Ramanathan', role: 'AI Transformation Advisor', description: 'Designs AI that amplifies human capabilities. Spots AI hype vs real opportunities.' },
                { id: 13, name: 'Robert Whitaker', role: 'Ethics and Equity Advisor', description: 'Ensures solutions benefit everyone fairly. Spots and fixes bias before it causes harm.' },
                { id: 14, name: 'Sophie Dubois', role: 'Weak Signals Analyst', description: 'Catches emerging changes years early. Spots patterns before they become trends.' },
                { id: 15, name: 'Zuri Kamau', role: 'Risk and Resilience Advisor', description: 'Builds systems that get stronger from shocks. Spots vulnerabilities before they hurt you.' }
            ];

            const project = state.projects.find(p => p.id === projectId);
            
            closeModal();
            showLoading(`Deploying ${selectedAgents.length} AI agent(s)...`);

            setTimeout(() => {
                let ideasGenerated = 0;
                selectedAgents.forEach(agentId => {
                    const agent = fullAiRoster.find(a => a.id === agentId);
                    if (agent && !project.aiTeam.some(ta => ta.id === agentId)) {
                        // Add agent to project
                        project.aiTeam.push(agent);
                        // Generate 1 idea for this newly added agent
                        const nextId = (project.ideas?.reduce((m, i) => Math.max(m, i.id), 0) || 0) + 1;
                        const idea = {
                            id: nextId,
                            title: `Initial Idea - ${agent.name}`,
                            content: `Idea generated by ${agent.name} based on their expertise (${agent.role}).`,
                            submittedBy: agent.name,
                            source: 'ai',
                            category: getCategoryForAgent(agent),
                            submittedDate: new Date()
                        };
                        if (!project.ideas) project.ideas = [];
                        project.ideas.push(idea);
                        ideasGenerated += 1;
                    }
                });

                hideLoading();
                showToast(`✓ Deployed ${selectedAgents.length} agent(s), generated ${ideasGenerated} idea(s)`, 'success');
                render();
            }, 800);
        }

        function removeAIAgentFromProject(projectId, agentId) {
            if (!confirm('Are you sure you want to remove this AI agent from the project?')) {
                return;
            }

            const project = state.projects.find(p => p.id === projectId);
            project.aiTeam = project.aiTeam.filter(a => a.id !== agentId);
            
            showToast('AI agent removed from project', 'success');
            render();
        }

        function showPage(pageName) {
            showToast('This feature will be available soon!', 'info');
        }

        function editIdea(ideaId) {
            const idea = state.currentProject.ideas.find(i => i.id === ideaId);
            if (!idea) return;
            
            showModal(
                '<i class="fas fa-edit"></i> Edit Idea',
                `
                    <form id="editIdeaForm">
                        <div class="form-group">
                            <label class="form-label">Idea Title *</label>
                            <input type="text" class="form-input" id="editIdeaTitle" value="${idea.title}" required>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Idea Description *</label>
                            <textarea class="form-textarea" id="editIdeaContent" required>${idea.content}</textarea>
                        </div>
                    </form>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveIdeaEdit(${ideaId})">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                `
            );
        }

        function saveIdeaEdit(ideaId) {
            const title = document.getElementById('editIdeaTitle').value.trim();
            const content = document.getElementById('editIdeaContent').value.trim();
            
            if (!title || !content) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            const idea = state.currentProject.ideas.find(i => i.id === ideaId);
            idea.title = title;
            idea.content = content;
            
            closeModal();
            showToast('✓ Idea updated successfully', 'success');
            render();
        }

        function deleteIdea(ideaId) {
            const idea = state.currentProject.ideas.find(i => i.id === ideaId);
            
            showModal(
                '<i class="fas fa-exclamation-triangle" style="color:var(--danger-red);"></i> Delete Idea',
                `
                    <div class="warning-box" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-exclamation-triangle"></i> This action cannot be undone.
                    </div>
                    <p style="margin-bottom: 1rem;">Are you sure you want to delete this idea?</p>
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px; border-left: 3px solid var(--danger-red);">
                        <strong>${idea.title}</strong>
                        <p class="text-muted" style="margin: 0.5rem 0 0 0;">${idea.content.substring(0, 100)}...</p>
                    </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="confirmDeleteIdea(${ideaId})">
                        <i class="fas fa-trash"></i> Yes, Delete Idea
                    </button>
                `
            );
        }

        function confirmDeleteIdea(ideaId) {
            closeModal();
            showLoading('Deleting idea...');
            
            setTimeout(() => {
                const project = state.currentProject;
                project.ideas = project.ideas.filter(i => i.id !== ideaId);
                
                hideLoading();
                showToast('✓ Idea deleted successfully', 'success');
                render();
            }, 500);
        }

        function renderProjects(container) {
            // This view is kept for potential future use but not actively used in the main flow
            // Users go directly from dashboard to project detail
            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="title-bar"></span>
                            My Projects
                        </h2>
                        <button class="btn btn-primary" onclick="startProjectWizard()">
                            <i class="fas fa-plus"></i> Create New Project
                        </button>
                    </div>
                    ${state.projects.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📋</div>
                            <h3>No Projects Yet</h3>
                            <p>Create your first project to get started.</p>
                        </div>
                    ` : `
                        <div class="project-cards">
                            ${state.projects.map(project => `
                                <div class="project-card" onclick="viewProject(${project.id})">
                                    <div class="project-card-title">${project.name}</div>
                                    <div class="project-card-meta">
                                        <i class="fas fa-calendar"></i> Created ${new Date(project.created).toLocaleDateString()}
                                    </div>
                                    <p style="margin-top: 0.75rem; color: var(--text-secondary);">${project.description}</p>
                                    <div class="mt-2" style="display: flex; gap: 0.5rem;">
                                        <span class="tag tag-new">${project.ideas.length} ideas</span>
                                        <span class="tag tag-completed">${project.votingSessions.length} votes</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderProjectDetail(container) {
            const project = state.currentProject;
            const activeTab = state.projectActiveTab || 'users';
            
            // Get categories - support both array and string format
            const categories = project.categories || (project.category ? project.category.split(',').map(c => c.trim()) : []);
            
            // Get timeline display text
            const timelineMap = {
                '0-2y': '0 to 2 Years',
                '2-5y': '2 to 5 Years',
                '5-10y': '5 to 10 Years',
                'other': 'Other'
            };
            const timelineText = timelineMap[project.timeline] || project.timeline || 'Not specified';
            
            // Get uploaded files
            const uploadedFiles = project.uploadedFiles || [];
            
            container.innerHTML = `
                <div class="card">
                    <!-- Project Header Section -->
                    <div style="background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%); border-bottom: 2px solid var(--border-color); padding: 2rem 2.5rem;">
                        <!-- Project Name -->
                        <div style="margin-bottom: 1.5rem;">
                            <h2 class="card-title" style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <span style="width: 4px; height: 1.8rem; background: var(--primary-blue); margin-right: 0.75rem; border-radius: 2px;"></span>
                                ${project.name}
                            </h2>
                        </div>
                        
                        <!-- Project Details Grid -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;">
                            <!-- Categories -->
                            <div>
                                <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; display: block;">Project Categories</label>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    ${categories.length > 0 ? categories.map(cat => `
                                        <span style="display: inline-block; padding: 0.4rem 0.75rem; background: var(--primary-blue); color: white; border-radius: 6px; font-size: 0.875rem; font-weight: 500;">
                                            ${cat}
                                        </span>
                                    `).join('') : '<span style="color: var(--text-secondary); font-size: 0.9rem;">No categories assigned</span>'}
                                </div>
                            </div>
                            
                            <!-- Timeline -->
                            <div>
                                <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; display: block;">Project Timeline</label>
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-calendar-alt" style="color: var(--primary-blue);"></i>
                                    <span style="font-size: 0.95rem; color: var(--text-primary); font-weight: 500;">${timelineText}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Project Description -->
                        <div style="margin-bottom: 1.5rem;">
                            <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; display: block;">Project Description</label>
                            <p style="color: var(--text-primary); font-size: 0.95rem; line-height: 1.6; margin: 0; padding: 1rem; background: white; border: 1px solid var(--border-color); border-radius: 8px;">
                                ${project.description || 'No description provided'}
                            </p>
                        </div>
                        
                        <!-- Attachments Section -->
                        ${uploadedFiles.length > 0 ? `
                        <div>
                            <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; display: block;">Project Documents (${uploadedFiles.length})</label>
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                                ${uploadedFiles.map((file, idx) => {
                                    const fileIcon = file.type === 'pdf' ? 'fa-file-pdf' : (file.type === 'docx' || file.type === 'doc') ? 'fa-file-word' : 'fa-file-powerpoint';
                                    const fileColor = file.type === 'pdf' ? '#dc2626' : (file.type === 'docx' || file.type === 'doc') ? '#2563eb' : '#f59e0b';
                                    const fileSize = file.size ? `(${(file.size / 1024).toFixed(1)} KB)` : '';
                                    
                                    return `
                                        <div style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: white; border: 1px solid var(--border-color); border-radius: 8px; transition: all 0.2s; cursor: pointer;" 
                                             onmouseover="this.style.borderColor='var(--primary-blue)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" 
                                             onmouseout="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none'"
                                             onclick="downloadFile('${file.name}', ${idx})">
                                            <i class="fas ${fileIcon}" style="font-size: 1.5rem; color: ${fileColor};"></i>
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="font-weight: 500; color: var(--text-primary); font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${file.name}">
                                                    ${file.name}
                                                </div>
                                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                                    ${fileSize}
                                                </div>
                                            </div>
                                            <i class="fas fa-download" style="color: var(--text-secondary); font-size: 0.875rem;"></i>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        ` : `
                        <div>
                            <label style="font-size: 0.875rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; display: block;">Project Documents</label>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0; padding: 0.75rem; background: #f9fafb; border: 1px dashed var(--border-color); border-radius: 8px;">
                                <i class="fas fa-file" style="margin-right: 0.5rem;"></i>No documents attached
                            </p>
                        </div>
                        `}
                    </div>

                    <!-- Project Tabs - Reordered: Users, AI Agents, Ideas, Voting Sessions -->
                    <div class="tabs">
                        <div class="tab ${activeTab === 'users' ? 'active' : ''}" onclick="switchProjectTab('users')">
                            <i class="fas fa-users"></i> Users
                        </div>
                        <div class="tab ${activeTab === 'ai-agents' ? 'active' : ''}" onclick="switchProjectTab('ai-agents')">
                            <i class="fas fa-robot"></i> AI Agents
                        </div>
                        <div class="tab ${activeTab === 'ideas' ? 'active' : ''}" onclick="switchProjectTab('ideas')">
                            <i class="fas fa-lightbulb"></i> Ideas
                        </div>
                        <div class="tab ${activeTab === 'voting' ? 'active' : ''}" onclick="switchProjectTab('voting')">
                            <i class="fas fa-vote-yea"></i> Voting Sessions
                        </div>
      </div>

                    <!-- Users Tab Content -->
                    <div class="tab-content ${activeTab === 'users' ? 'active' : ''}" id="tab-users">
                        ${renderUsersTab(project)}
      </div>

                    <!-- AI Agents Tab Content -->
                    <div class="tab-content ${activeTab === 'ai-agents' ? 'active' : ''}" id="tab-ai-agents">
                        ${renderAIAgentsTab(project)}
    </div>

                    <!-- Ideas Tab Content -->
                    <div class="tab-content ${activeTab === 'ideas' ? 'active' : ''}" id="tab-ideas">
                        ${renderIdeasTab(project)}
                    </div>

                    <!-- Voting Sessions Tab Content -->
                    <div class="tab-content ${activeTab === 'voting' ? 'active' : ''}" id="tab-voting">
                        ${renderVotingSessionsTab(project)}
                    </div>
                </div>
            `;
        }

        function renderIdeasTab(project) {
            // Group ideas by category
            const ideasByCategory = {};
            project.ideas.forEach(idea => {
                const category = idea.category || 'Uncategorized';
                if (!ideasByCategory[category]) {
                    ideasByCategory[category] = [];
                }
                ideasByCategory[category].push(idea);
            });
            
            // Sort categories alphabetically
            const sortedCategories = Object.keys(ideasByCategory).sort();
            
            return `
                <div style="padding: 2.5rem 2.5rem 2.5rem;">
                    <!-- Header with Title and Description -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span class="title-bar" style="height: 1.75rem;"></span>
                            <i class="fas fa-lightbulb" style="margin-right: 0.6rem; color: var(--primary-blue);"></i>
                            <span>All Ideas (${project.ideas.length})</span>
                        </h3>
                        <p class="text-muted" style="margin-left: 2rem; font-size: 0.95rem;">Manage and organize strategic ideas for this project</p>
                    </div>

                    <!-- Search Bar and Action Buttons -->
                    <div class="search-action-bar">
                        <input type="text" class="form-input" id="ideaSearch" placeholder="🔍 Search ideas by title, content, or author..." onkeyup="filterIdeas()" style="margin: 0;">
                        <div class="flex gap-2" style="flex-shrink: 0;">
                            <button class="btn btn-outline" onclick="showManualIdeaForm()">
                                <i class="fas fa-plus"></i> Add Manually
                            </button>
                            <button class="btn btn-primary" onclick="showInviteHumansToIdeas()">
                                <i class="fas fa-user-plus"></i> Invite Human to Ideas
                            </button>
                        </div>
                    </div>

                    ${project.ideas.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">💡</div>
                            <h3>No Ideas Yet</h3>
                            <p>Add ideas manually or generate them with your deployed AI agents.</p>
                            <div class="flex gap-2 flex-center" style="margin-top: 1rem;">
                                <button class="btn btn-outline" onclick="showManualIdeaForm()">
                                    <i class="fas fa-plus"></i> Add Idea Manually
                                </button>
                                <button class="btn btn-primary" onclick="showAIGenerateModal()">
                                    <i class="fas fa-robot"></i> Generate Ideas with AI
                                </button>
                            </div>
                        </div>
                    ` : `
                        <div id="ideasContainer">
                            ${sortedCategories.map((category, catIdx) => `
                                <div style="margin-bottom: ${catIdx < sortedCategories.length - 1 ? '3rem' : '0'};">
                                    <h4 style="font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border-color);">
                                        ${category}
                                    </h4>
                                    <div style="background: white; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                        <table style="width: 100%; border-collapse: collapse;">
          <thead>
                                                <tr style="background: #f9fafb; border-bottom: 1px solid var(--border-color);">
                                                    <th style="width: 40px; padding: 0.75rem 1rem; text-align: left;">
                                                        <input type="checkbox" style="width: 18px; height: 18px; cursor: pointer;" onchange="toggleAllCategoryIdeas('${category}', this.checked)">
                                                    </th>
                                                    <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary);">Idea Title</th>
                                                    <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary);">Description</th>
                                                    <th style="padding: 0.75rem 1rem; text-align: left; font-weight: 600; color: var(--text-primary);">Author</th>
                                                    <th style="padding: 0.75rem 1rem; text-align: center; font-weight: 600; color: var(--text-primary); width: 200px;">Action</th>
            </tr>
          </thead>
          <tbody>
                                                ${ideasByCategory[category].map((idea, idx) => `
                                                    <tr style="border-bottom: 1px solid #f0f2f5; transition: all 0.2s;" onmouseover="this.style.background='#fafbfd'" onmouseout="this.style.background='white'">
                                                        <td style="padding: 1rem;">
                                                            <input type="checkbox" class="idea-checkbox" value="${idea.id}" style="width: 18px; height: 18px; cursor: pointer;">
              </td>
                                                        <td style="padding: 1rem;">
                                                            <strong style="font-size: 1rem; color: var(--text-primary);">${idea.title}</strong>
              </td>
                                                        <td style="padding: 1rem;">
                                                            <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem; line-height: 1.5; max-width: 400px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${idea.content}</p>
                                                        </td>
                                                        <td style="padding: 1rem;">
                                                            <span style="font-size: 0.9rem; color: var(--text-primary);">${idea.submittedBy || '—'}</span>
                                                        </td>
                                                        <td style="padding: 1rem; text-align: center;">
                                                            <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                                                <i class="fas fa-edit" onclick="editIdea(${idea.id})" style="color: var(--text-secondary); cursor: pointer; font-size: 1.05rem; padding: 0.5rem; border-radius: 6px; transition: all 0.2s;" title="Edit" onmouseover="this.style.background='var(--secondary-blue)'; this.style.color='var(--primary-blue)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"></i>
                                                                <i class="fas fa-trash-alt" onclick="deleteIdea(${idea.id})" style="color: var(--text-secondary); cursor: pointer; font-size: 1.05rem; padding: 0.5rem; border-radius: 6px; transition: all 0.2s;" title="Delete" onmouseover="this.style.background='#fee2e2'; this.style.color='var(--danger-red)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"></i>
                                                                ${idea.source === 'ai' ? `<span style="display: inline-block; padding: 0.35rem 0.75rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; background: #e8daef; color: #6c3483; margin-left: 0.5rem;">AI Agent Generated</span>` : `<span style="display: inline-block; padding: 0.35rem 0.75rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600; background: #d4edda; color: #155724; margin-left: 0.5rem;">New Idea</span>`}
                </div>
              </td>
            </tr>
                                                `).join('')}
          </tbody>
        </table>
      </div>
                                </div>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function toggleAllCategoryIdeas(category, checked) {
            const container = document.getElementById('ideasContainer');
            if (!container) return;
            const allH4s = container.querySelectorAll('h4');
            let categorySection = null;
            for (let h4 of allH4s) {
                if (h4.textContent.trim() === category) {
                    categorySection = h4.closest('div');
                    break;
                }
            }
            if (!categorySection) return;
            const checkboxes = categorySection.querySelectorAll('.idea-checkbox');
            checkboxes.forEach(cb => cb.checked = checked);
        }

        function getCategoryForAgent(agent) {
            // Map agent roles to categories based on new agent names and roles
            const role = agent.role || '';
            const name = agent.name || '';
            
            // Risk/Compliance
            if (role.includes('Risk') || role.includes('Resilience') || name === 'Zuri Kamau') {
                return 'Risk/Compliance';
            }
            
            // Data/AI
            if (role.includes('AI') || role.includes('Transformation') || name === 'Priya Ramanathan') {
                return 'Data/AI';
            }
            
            // Supply Chain Management
            if (role.includes('Implementation') || role.includes('Operations') || name === 'Park Mi-kyung') {
                return 'Supply Chain Management';
            }
            
            // AI and Analytics
            if (role.includes('Behavioral') || role.includes('Business Models') || role.includes('Innovation') || 
                role.includes('Scenarios') || role.includes('Futures') || role.includes('Signals') ||
                name === 'Ayu Laksmi' || name === 'Alexander Petrov' || name === 'Diego Morales' || 
                name === 'Lars Nyström' || name === 'Mariam Okoye' || name === 'Sophie Dubois') {
                return 'AI and Analytics';
            }
            
            // Sustainability
            if (role.includes('Ethics') || role.includes('Equity') || role.includes('Climate') || 
                name === 'Robert Whitaker') {
                return 'Sustainability';
            }
            
            // Finance
            if (role.includes('Finance') || name === 'Omar Khan') {
                return 'Finance';
            }
            
            // Technology
            if (role.includes('Science Fiction') || role.includes('Complexity') || name === 'Hiro Tanaka' || name === 'Chen Wei') {
                return 'Technology';
            }
            
            // International/Best Practices
            if (role.includes('International') || role.includes('Best Practices') || name === 'Fatima Al-Hassan') {
                return 'AI and Analytics';
            }
            
            // Contrarian Thinker
            if (role.includes('Contrarian') || name === 'Alex Carter') {
                return 'AI and Analytics';
            }
            
            // Default category
            return 'Data/AI';
        }

        function renderVotingSessionsTab(project) {
            return `
                <div style="padding: 2.5rem 2.5rem 2.5rem;">
                    <!-- Header with Title and Description -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span class="title-bar" style="height: 1.75rem;"></span>
                            <i class="fas fa-vote-yea" style="margin-right: 0.6rem; color: var(--primary-blue);"></i>
                            <span>Voting Sessions (${project.votingSessions.length})</span>
                        </h3>
                        <p class="text-muted" style="margin-left: 2rem; font-size: 0.95rem;">Create and manage voting sessions for idea evaluation</p>
                    </div>

                    <!-- Search Bar and Add Button -->
                    <div class="search-action-bar">
                        <input type="text" class="form-input" placeholder="🔍 Search voting sessions..." style="margin: 0;">
                        <button class="btn btn-primary" onclick="startVotingWizard()" style="flex-shrink: 0;">
                            <i class="fas fa-plus"></i> New Session
                        </button>
                    </div>

                    ${project.votingSessions.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">🗳️</div>
                            <h3>No Voting Sessions Yet</h3>
                            <p>Create a voting session to gather feedback on your ideas from your team and AI agents.</p>
                            <button class="btn btn-primary" onclick="startVotingWizard()" style="margin-top: 1rem;">
                                <i class="fas fa-plus"></i> New Voting Session
                            </button>
                        </div>
                    ` : `
                        <!-- Voting Sessions List -->
                        <div style="background: white; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                            ${project.votingSessions.map((session, idx) => `
                                <div onclick="viewVotingResults(${project.id}, ${session.id})" style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem 2rem; ${idx < project.votingSessions.length - 1 ? 'border-bottom: 1px solid #f0f2f5;' : ''} transition: all 0.2s; background: white; cursor: pointer;" onmouseover="this.style.background='#fafbfd'" onmouseout="this.style.background='white'">
                                    <!-- Session Icon -->
                                    <div style="width: 48px; height: 48px; border-radius: 8px; background: ${session.status === 'completed' ? 'linear-gradient(135deg, #28a745, #1e7e34)' : 'linear-gradient(135deg, var(--primary-blue), var(--primary-dark))'}; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; flex-shrink: 0;">
                                        ${session.status === 'completed' ? '✓' : '🗳️'}
                                    </div>
                                    
                                    <!-- Session Name and Details -->
                                    <div style="flex: 1; min-width: 0;">
                                        <strong style="font-size: 1.05rem; color: var(--text-primary); display: block; margin-bottom: 0.5rem;">${session.name}</strong>
                                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.85rem;">
                                            <i class="fas fa-calendar"></i> 
                                            <span>${new Date(session.startDate).toLocaleDateString()} - ${new Date(session.endDate).toLocaleDateString()}</span>
                                        </div>
                                        <div style="display: flex; gap: 1.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                            <span><i class="fas fa-lightbulb" style="margin-right: 0.35rem;"></i> ${session.selectedIdeas.length} ideas</span>
                                            <span><i class="fas fa-users" style="margin-right: 0.35rem;"></i> ${session.humanVoters.length} human</span>
                                            <span><i class="fas fa-robot" style="margin-right: 0.35rem;"></i> ${session.aiVoters.length} AI</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Status Badge -->
                                    <div style="flex-shrink: 0;">
                                        <span style="display: inline-block; padding: 0.45rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; ${session.status === 'completed' ? 'background: #d4edda; color: #155724;' : session.status === 'active' ? 'background: #d1ecf1; color: #0c5460;' : 'background: #e2e3e5; color: #383d41;'}">
                                            ${session.status.charAt(0).toUpperCase() + session.status.slice(1)}
                                        </span>
                                    </div>
                                    
                                    <!-- View Results Button or Clock -->
                                    ${session.status === 'completed' ? `
                                        <div style="flex-shrink: 0;">
                                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); viewVotingResults(${project.id}, ${session.id})">
                                                <i class="fas fa-chart-bar"></i> Results
                                            </button>
                                        </div>
                                    ` : `
                                        <div style="flex-shrink: 0; color: var(--text-secondary); font-size: 0.9rem;">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Pagination -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 0 0.5rem;">
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                Showing 1 to ${project.votingSessions.length} of ${project.votingSessions.length} results
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="btn btn-sm btn-outline" disabled>Previous</button>
                                <button class="btn btn-sm" style="background: var(--primary-blue); color: white; min-width: 40px;">1</button>
                                <button class="btn btn-sm btn-outline" disabled>Next</button>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderUsersTab(project) {
            return `
                <div style="padding: 2.5rem 2.5rem 2.5rem;">
                    <!-- Header with Title and Description -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span class="title-bar" style="height: 1.75rem;"></span>
                            <i class="fas fa-users" style="margin-right: 0.6rem; color: var(--primary-blue);"></i> 
                            <span>Human Team (${project.humanTeam.length})</span>
                        </h3>
                        <p class="text-muted" style="margin-left: 2rem; font-size: 0.95rem;">Team members who can contribute ideas and vote</p>
                    </div>

                    <!-- Search Bar and Action Button -->
                    <div class="search-action-bar">
                        <input type="text" class="form-input" placeholder="🔍 Search users..." style="margin: 0;">
                        <button class="btn btn-primary" onclick="showInviteModal()" style="flex-shrink: 0;">
                            <i class="fas fa-envelope"></i> Invite New Participant
                        </button>
                    </div>
                    ${project.humanTeam.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">👥</div>
                            <h3>No Team Members Yet</h3>
                            <p>Invite team members to contribute ideas and participate in voting.</p>
                            <button class="btn btn-primary" onclick="showInviteModal()" style="margin-top: 1rem;">
                                <i class="fas fa-envelope"></i> Invite New Participant
                            </button>
                        </div>
                    ` : `
                        <!-- User List -->
                        <div style="background: white; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                            ${project.humanTeam.map((member, idx) => `
                                <div style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem 2rem; ${idx < project.humanTeam.length - 1 ? 'border-bottom: 1px solid #f0f2f5;' : ''} transition: all 0.2s; background: white;" onmouseover="this.style.background='#fafbfd'" onmouseout="this.style.background='white'">
                                    <!-- Avatar with Initials -->
                                    <div style="width: 48px; height: 48px; border-radius: 8px; background: linear-gradient(135deg, var(--primary-blue), var(--primary-dark)); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.15rem; flex-shrink: 0;">
                                        ${member.name.split(' ').map(n => n.charAt(0)).join('').substring(0, 2)}
                                    </div>
                                    
                                    <!-- Name and Email -->
                                    <div style="flex: 1; min-width: 0;">
                                        <strong style="font-size: 1.05rem; color: var(--text-primary); display: block; margin-bottom: 0.25rem;">${member.name}</strong>
                                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">${member.email}</p>
                                    </div>
                                    
                                    <!-- Status Badge -->
                                    <div style="flex-shrink: 0;">
                                        <span style="display: inline-block; padding: 0.45rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; ${member.status === 'active' ? 'background: #d1ecf1; color: #0c5460;' : 'background: #fcf3cf; color: #856404;'}">
                                            ${member.status === 'active' ? 'Draft' : 'Submitted'}
                                        </span>
                                    </div>
                                    
                                    <!-- Action Icons -->
                                    <div style="flex-shrink: 0; display: flex; gap: 0.5rem;">
                                        <i class="fas fa-eye" onclick="viewUserDetails(${project.id}, ${member.id})" style="color: var(--text-secondary); cursor: pointer; font-size: 1.05rem; padding: 0.6rem; border-radius: 6px; transition: all 0.2s;" title="View User" onmouseover="this.style.background='var(--secondary-blue)'; this.style.color='var(--primary-blue)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"></i>
                                        <i class="fas fa-trash-alt" onclick="removeUserFromProject(${project.id}, ${member.id})" style="color: var(--text-secondary); cursor: pointer; font-size: 1.05rem; padding: 0.6rem; border-radius: 6px; transition: all 0.2s;" title="Remove User" onmouseover="this.style.background='#fee2e2'; this.style.color='var(--danger-red)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Pagination -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 0 0.5rem;">
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                Showing 1 to ${project.humanTeam.length} of ${project.humanTeam.length} results
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="btn btn-sm btn-outline" disabled>Previous</button>
                                <button class="btn btn-sm" style="background: var(--primary-blue); color: white; min-width: 40px;">1</button>
                                <button class="btn btn-sm btn-outline" disabled>Next</button>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderAIAgentsTab(project) {
            return `
                <div style="padding: 2.5rem 2.5rem 2.5rem;">
                    <!-- Header with Title and Description -->
                    <div style="margin-bottom: 1.5rem;">
                        <h3 style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <span class="title-bar" style="height: 1.75rem;"></span>
                            <i class="fas fa-robot" style="margin-right: 0.6rem; color: var(--primary-blue);"></i> 
                            <span>AI Team (${project.aiTeam.length})</span>
                        </h3>
                        <p class="text-muted" style="margin-left: 2rem; font-size: 0.95rem;">Deployed AI agents that can generate ideas and vote</p>
                    </div>

                    <!-- Search Bar and Add Button -->
                    <div class="search-action-bar">
                        <input type="text" class="form-input" placeholder="🔍 Search AI agents..." style="margin: 0;">
                        <button class="btn btn-primary" onclick="showAddAIAgentToProjectModal(${project.id})" style="flex-shrink: 0;">
                            <i class="fas fa-robot"></i> Add AI Agent
                        </button>
                    </div>
                    ${project.aiTeam.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">🤖</div>
                            <h3>No AI Agents Deployed</h3>
                            <p>Deploy AI agents to help generate ideas and participate in voting sessions.</p>
                            <button class="btn btn-primary" onclick="showAddAIAgentToProjectModal(${project.id})" style="margin-top: 1rem;">
                                <i class="fas fa-robot"></i> Add AI Agent
                            </button>
                        </div>
                    ` : `
                        <!-- AI Agent List -->
                        <div style="background: white; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                            ${project.aiTeam.map((agent, idx) => `
                                <div style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem 2rem; ${idx < project.aiTeam.length - 1 ? 'border-bottom: 1px solid #f0f2f5;' : ''} transition: all 0.2s; background: white;" onmouseover="this.style.background='#fafbfd'" onmouseout="this.style.background='white'">
                                    <!-- Agent Avatar/Icon -->
                                    <div style="width: 48px; height: 48px; border-radius: 8px; background: linear-gradient(135deg, #8a2be2, #6a1bb2); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                                        🤖
                                    </div>
                                    
                                    <!-- Name and Description -->
                                    <div style="flex: 1; min-width: 0;">
                                        <strong style="font-size: 1.05rem; color: var(--text-primary); display: block; margin-bottom: 0.25rem;">${agent.name}</strong>
                                        <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">${agent.description}</p>
                                    </div>
                                    
                                    <!-- Role Badge -->
                                    <div style="flex-shrink: 0;">
                                        <span style="display: inline-block; padding: 0.45rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: #e8daef; color: #6c3483;">
                                            ${agent.role || 'AI Agent'}
                                        </span>
                                    </div>
                                    
                                    <!-- View Icon -->
                                    <div style="flex-shrink: 0;">
                                        <i class="fas fa-eye" onclick="viewAIAgentDetails(${project.id}, ${agent.id})" style="color: var(--text-secondary); cursor: pointer; font-size: 1.05rem; padding: 0.6rem; border-radius: 6px; transition: all 0.2s;" title="View AI Agent Details" onmouseover="this.style.background='var(--secondary-blue)'; this.style.color='var(--primary-blue)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"></i>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <!-- Pagination -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 0 0.5rem;">
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">
                                Showing 1 to ${project.aiTeam.length} of ${project.aiTeam.length} results
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button class="btn btn-sm btn-outline" disabled>Previous</button>
                                <button class="btn btn-sm" style="background: var(--primary-blue); color: white; min-width: 40px;">1</button>
                                <button class="btn btn-sm btn-outline" disabled>Next</button>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function switchProjectTab(tabName) {
            state.projectActiveTab = tabName;
            render();
        }

        function renderAssignmentsDashboard(container) {
            const assignments = state.projects.filter(p => 
                p.humanTeam.some(m => m.email === state.currentUser.email)
            );

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title"><i class="fas fa-tasks"></i> My Assignments</h2>
                        <p class="text-muted" style="margin-top: 0.5rem;">Projects you've been invited to contribute to</p>
                    </div>
                    ${assignments.length === 0 ? `
                        <div class="empty-state">
                            <div class="empty-state-icon">📬</div>
                            <h3>No Assignments Yet</h3>
                            <p>You have not been assigned to any projects yet. You'll receive an email when a project owner invites you.</p>
                        </div>
                    ` : `
                        <div class="project-cards">
                            ${assignments.map(project => {
                                const activeVoting = project.votingSessions.find(v => v.status === 'active');
                                const daysLeft = activeVoting ? Math.ceil((new Date(activeVoting.endDate) - new Date()) / (1000 * 60 * 60 * 24)) : 0;
                                const myIdeas = project.ideas.filter(i => i.submittedBy === state.currentUser.name && i.source === 'human');
                                
                                return `
                                    <div class="project-card" onclick="viewAssignment(${project.id})">
                                        <div class="project-card-title" style="margin-bottom: 0.75rem;">${project.name}</div>
                                        <div class="project-card-meta" style="margin-bottom: 1rem;">
                                            <i class="fas fa-user"></i> Assigned by ${project.owner}
                                        </div>
                                        <p style="color: var(--text-secondary); font-size: 0.95rem; line-height: 1.6; margin-bottom: 1.25rem;">${project.description.substring(0, 140)}${project.description.length > 140 ? '...' : ''}</p>
                                        <div style="padding-top: 1.25rem; border-top: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; gap: 1rem;">
                                            ${activeVoting ? `
                                                <span class="tag tag-active" style="font-weight: 600; padding: 0.5rem 1rem;">
                                                    <i class="fas fa-vote-yea"></i> Voting Active (${daysLeft} ${daysLeft === 1 ? 'day' : 'days'} left)
                                                </span>
                                            ` : `
                                                <span class="tag tag-pending" style="padding: 0.5rem 1rem;">
                                                    <i class="fas fa-lightbulb"></i> Idea Gathering
                                                </span>
                                            `}
                                            <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">
                                                <i class="fas fa-lightbulb"></i> ${myIdeas.length} ${myIdeas.length === 1 ? 'idea' : 'ideas'}
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderAssignmentDetail(container) {
            const project = state.currentProject;
            const activeVoting = project.votingSessions.find(v => v.status === 'active');
            const myIdeas = project.ideas.filter(i => i.submittedBy === state.currentUser.name && i.source === 'human');
            const completedVoting = project.votingSessions.find(v => v.status === 'completed' && v.humanVoters.includes(state.currentUser.id));

            container.innerHTML = `
                <!-- Active Tasks Section (Top Priority) -->
                ${activeVoting ? `
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 2rem; border: none; box-shadow: 0 4px 16px rgba(102, 126, 234, 0.3);">
                        <div style="padding: 2rem 2.5rem;">
                            <h3 style="color: white; display: flex; align-items: center; gap: 0.6rem; margin-bottom: 1.25rem; font-size: 1.3rem;">
                                <i class="fas fa-exclamation-circle"></i> Active Tasks
                            </h3>
                            <div style="background: rgba(255,255,255,0.15); padding: 1.75rem; border-radius: 12px; backdrop-filter: blur(10px);">
                                <div class="flex-between" style="align-items: flex-start; gap: 2rem;">
                                    <div style="flex: 1;">
                                        <strong style="font-size: 1.2rem; color: white; display: block; margin-bottom: 0.85rem;">A new voting session is open</strong>
                                        <div style="display: flex; flex-direction: column; gap: 0.5rem; opacity: 0.95; font-size: 0.95rem;">
                                            <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="fas fa-clock"></i> Voting ends ${new Date(activeVoting.endDate).toLocaleDateString()}
                                            </p>
                                            <p style="margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                                                <i class="fas fa-lightbulb"></i> ${activeVoting.selectedIdeas.length} ideas to vote on
                                            </p>
                                        </div>
                                    </div>
                                    <button class="btn btn-success" onclick="startVoting(${project.id}, ${activeVoting.id})" style="background: white; color: var(--primary-blue); font-weight: 600; flex-shrink: 0; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                                        <i class="fas fa-vote-yea"></i> Start Voting
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : completedVoting ? `
                    <div class="card" style="background: linear-gradient(135deg, var(--success-green), #1e8449); color: white; margin-bottom: 2rem; border: none; box-shadow: 0 4px 16px rgba(40, 167, 69, 0.3);">
                        <div style="text-align: center; padding: 2.5rem 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 3.5rem; margin-bottom: 1rem;"></i>
                            <h3 style="color: white; margin: 0 0 0.75rem 0; font-size: 1.5rem;">Voting Complete</h3>
                            <p style="margin: 0; opacity: 0.95; font-size: 1.05rem;">Thank you for your contribution! The owner will review results soon.</p>
                        </div>
                    </div>
                ` : ''}

                <!-- Project Overview -->
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-header" style="border-bottom: 1px solid var(--border-color);">
        <div>
                            <h2 class="card-title" style="display: flex; align-items: center;">
                                <span style="width: 4px; height: 1.8rem; background: var(--primary-blue); margin-right: 0.75rem; border-radius: 2px;"></span>
                                ${project.name}
                            </h2>
                            <p class="text-muted" style="margin-top: 0.5rem; margin-left: 1.5rem;">${project.description}</p>
        </div>
                    </div>
                    <div style="padding: 1.5rem; background: var(--bg-light);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">Status</div>
                                <div style="font-weight: 600; margin-top: 0.25rem;">
                                    <span class="tag tag-active">${activeVoting ? 'Voting Active' : 'Idea Gathering'}</span>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">Assigned By</div>
                                <div style="font-weight: 600; margin-top: 0.25rem;">${project.owner}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">My Contributions</div>
                                <div style="font-weight: 600; margin-top: 0.25rem;">${myIdeas.length} ${myIdeas.length === 1 ? 'idea' : 'ideas'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contribute Your Idea -->
                <div class="card" style="margin-bottom: 2rem;">
                    <div style="padding: 2rem 2.5rem;">
                        <h3 style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                            <span class="title-bar" style="height: 1.75rem;"></span>
                            <i class="fas fa-lightbulb" style="margin-right: 0.6rem; color: var(--primary-blue);"></i> 
                            <span>Contribute Your Idea</span>
                        </h3>
                        <p class="text-muted" style="margin-left: 2rem; margin-bottom: 2rem; font-size: 0.95rem;">Share your strategic insights and ideas for this project</p>
                        <form onsubmit="submitIdea(event, ${project.id})">
                            <div class="form-group">
                                <label class="form-label">Idea Title *</label>
                                <input type="text" class="form-input" id="ideaTitle" placeholder="Enter a descriptive title for your idea" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Idea Content *</label>
                                <textarea class="form-textarea" id="ideaContent" placeholder="Describe your idea in detail..." required></textarea>
                            </div>
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-paper-plane"></i> Submit My Idea
                            </button>
                        </form>
                    </div>
      </div>

                <!-- My Submitted Ideas -->
                <div class="card">
                    <div style="padding: 2rem 2.5rem;">
                        <h3 style="display: flex; align-items: center; margin-bottom: 0.75rem;">
                            <span class="title-bar" style="height: 1.75rem;"></span>
                            <i class="fas fa-list" style="margin-right: 0.6rem; color: var(--primary-blue);"></i> 
                            <span>My Submitted Ideas (${myIdeas.length})</span>
                        </h3>
                        ${myIdeas.length === 0 ? `
                            <div class="empty-state" style="margin: 1rem 0; padding: 3rem 2rem;">
                                <div class="empty-state-icon">📝</div>
                                <p>You haven't submitted any ideas yet. Use the form above to contribute!</p>
      </div>
                        ` : `
                            <div style="margin-top: 1.5rem; display: grid; gap: 1.25rem;">
                                ${myIdeas.map(idea => `
                                    <div style="background: linear-gradient(to right, #f8fffe, white); border: 1px solid var(--border-color); border-left: 3px solid var(--success-green); border-radius: 10px; padding: 1.5rem 1.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.04);">
                                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1.5rem;">
                                            <div style="flex: 1; min-width: 0;">
                                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem;">
                                                    <strong style="font-size: 1.05rem; color: var(--text-primary);">${idea.title}</strong>
                                                    <span class="tag tag-submitted">Submitted</span>
    </div>
                                                <p style="color: var(--text-secondary); margin: 0 0 0.75rem 0; line-height: 1.6;">${idea.content}</p>
                                                <div style="font-size: 0.875rem; color: var(--text-secondary);">
                                                    <i class="fas fa-calendar"></i> Submitted on ${new Date(idea.submittedDate).toLocaleDateString()}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderVoting(container) {
            const project = state.currentProject;
            const session = state.currentVotingSession;
            const ideasToVote = session.selectedIdeas;

            container.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">${session.name}</h2>
                        <p class="text-muted">Vote on ${ideasToVote.length} ideas</p>
                    </div>

                    <div id="votingContainer">
                        ${ideasToVote.map((ideaId, index) => {
                            const idea = project.ideas.find(i => i.id === ideaId);
                            return `
                                <div class="voting-card" id="idea-${ideaId}">
                                    <div class="voting-card-header">
                                        <div class="text-muted">Idea ${index + 1} of ${ideasToVote.length}</div>
                                        <div class="voting-card-title">${idea.title}</div>
                                        <p>${idea.content}</p>
                                        <div class="mt-2">
                                            <span class="tag ${idea.source === 'ai' ? 'tag-ai' : 'tag-human'}">
                                                ${idea.source === 'ai' ? `AI Agent Generated: ${idea.submittedBy}` : `Submitted by: ${idea.submittedBy}`}
                                            </span>
                                        </div>
                                    </div>
                                    <div class="voting-actions">
                                        <button class="vote-btn down" onclick="castVote(${ideaId}, 'down')">👎 Not Favorable</button>
                                        <button class="vote-btn up" onclick="castVote(${ideaId}, 'up')">👍 Favorable</button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="text-center mt-2">
                        <button class="btn btn-success" onclick="submitAllVotes(${project.id}, ${session.id})">Submit All Votes</button>
                    </div>
                </div>
            `;
        }

        function renderVotingResults(container) {
            const project = state.currentProject;
            const session = state.currentVotingSession;

            container.innerHTML = `
                <div class="card">
                    <div class="card-header" style="border-bottom: 1px solid var(--border-color);">
                        <div>
                            <h2 class="card-title">
                                <span class="title-bar"></span>
                                ${session.name} - Results
                            </h2>
                            <p class="text-muted" style="margin-top: 0.5rem; margin-left: 1.5rem;">
                                <i class="fas fa-calendar"></i> ${new Date(session.startDate).toLocaleDateString()} - ${new Date(session.endDate).toLocaleDateString()}
                            </p>
                        </div>
                    </div>

                    <div style="padding: 0 2rem 1.5rem;">
                        <div class="results-filter">
                            <label class="form-label" style="margin: 0; font-weight: 600;">View By:</label>
                            <select class="form-select" onchange="updateResultsView(this.value)" style="width: auto; min-width: 200px;">
                                <option value="combined">Combined Score</option>
                                <option value="human">Human-Only Score</option>
                                <option value="ai">AI-Only Score</option>
                                <option value="compare">Compare: Human vs. AI</option>
                            </select>
                        </div>

                        <div id="resultsContainer">
                            ${renderResultsView('combined', session, project)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderResultsView(viewType, session, project) {
            const results = session.results.sort((a, b) => {
                if (viewType === 'combined') return b.combinedScore - a.combinedScore;
                if (viewType === 'human') return b.humanScore - a.humanScore;
                if (viewType === 'ai') return b.aiScore - a.aiScore;
                return b.combinedScore - a.combinedScore;
            });

            return `
                <ul class="results-list">
                    ${results.map((result, index) => {
                        const idea = project.ideas.find(i => i.id === result.ideaId);
                        return `
                            <li class="result-item">
                                <div class="result-rank">#${index + 1}</div>
                                <div class="result-content">
                                    <div class="result-title">${idea.title}</div>
                                    <p class="text-muted">${idea.content}</p>
                                </div>
                                <div class="result-scores">
                                    ${viewType === 'combined' ? `
                                        <div class="score-item">
                                            <div class="score-value">${result.combinedScore}</div>
                                            <div class="score-label">Combined</div>
                                        </div>
                                    ` : ''}
                                    ${viewType === 'human' || viewType === 'compare' ? `
                                        <div class="score-item">
                                            <div class="score-value">${result.humanScore}</div>
                                            <div class="score-label">Human</div>
                                        </div>
                                    ` : ''}
                                    ${viewType === 'ai' || viewType === 'compare' ? `
                                        <div class="score-item">
                                            <div class="score-value">${result.aiScore}</div>
                                            <div class="score-label">AI</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </li>
                        `;
                    }).join('')}
                </ul>
            `;
        }

        // Modal Functions
        let __lastFocusedElement = null;
        let __modalKeydownHandler = null;

        function showModal(title, body, footer) {
            __lastFocusedElement = document.activeElement;
            document.getElementById('modalTitle').innerHTML = title;
            document.getElementById('modalBody').innerHTML = body;
            document.getElementById('modalFooter').innerHTML = footer;
            document.getElementById('modalOverlay').classList.add('active');

            // Focus trap
            const overlay = document.getElementById('modalOverlay');
            const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusable.length) {
                focusable[0].focus();
            }

            __modalKeydownHandler = function(e) {
                if (e.key === 'Tab') {
                    const list = Array.from(overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled && el.offsetParent !== null);
                    if (!list.length) return;
                    const first = list[0];
                    const last = list[list.length - 1];
                    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
                }
            };
            document.addEventListener('keydown', __modalKeydownHandler);
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
            if (__modalKeydownHandler) document.removeEventListener('keydown', __modalKeydownHandler);
            if (__lastFocusedElement && typeof __lastFocusedElement.focus === 'function') {
                __lastFocusedElement.focus();
            }
        }

        // Click outside modal to close
        document.addEventListener('click', function(e) {
            const modalOverlay = document.getElementById('modalOverlay');
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        // Loading Functions
        function showLoading(message = 'Loading...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            text.textContent = message;
            overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            overlay.classList.remove('active');
        }

        // Toast Functions with auto-dismiss
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toast.className = `toast ${type} active`;
            toastMessage.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, type === 'success' ? 3000 : 4000);
        }

        // Success Modal with Animation
        function showSuccessModal(title, message, onClose) {
            const modalBody = `
                <div class="success-checkmark">
                    <div class="check-icon">
                        <span class="icon-line line-tip"></span>
                        <span class="icon-line line-long"></span>
                    </div>
                </div>
                <h3 style="text-align: center; margin-bottom: 0.5rem; color: var(--success-green);">${title}</h3>
                <p style="text-align: center; color: var(--text-secondary);">${message}</p>
            `;
            
            const modalFooter = `
                <button class="btn btn-primary" onclick="closeModal(); ${onClose ? onClose + '()' : ''}">
                    Continue <i class="fas fa-arrow-right"></i>
                </button>
            `;
            
            showModal(title, modalBody, modalFooter);
        }

        // Action Functions
        function purchaseLicenses() {
            // Streamlined: One-click purchase (default to Starter for demo)
            const licenses = 10;
            const aiAgents = 25;
            
            showLoading('Processing your purchase...');
            
            setTimeout(() => {
                state.currentUser.hasLicenses = true;
                state.currentUser.licenses = licenses;
                state.currentUser.aiAgents = aiAgents;
                
                hideLoading();
                updateMetrics();
                
                // Direct success message without modal
                showToast(`✓ Purchase successful! ${licenses} licenses & ${aiAgents} AI agents ready`, 'success');
                
                // Auto-render to show projects view
                render();
                
                // Quick tip after render
                setTimeout(() => {
                    showToast('💡 Create your first project to get started', 'info');
                }, 2000);
            }, 1000);
        }

        // Project Wizard
        function startProjectWizard() {
            state.wizardStep = 1;
            state.wizardData = {};
            document.getElementById('wizard').classList.add('active');
            renderWizard();
        }

        function isStep1Complete() {
            // Prefer live DOM values if on step 1
            const nameEl = document.getElementById('projectName');
            const categoryEl = document.getElementById('projectCategory');
            const descEl = document.getElementById('projectDescription');
            const timelineEl = document.querySelector('input[name="projectTimeline"]:checked');
            const name = nameEl ? nameEl.value.trim() : (state.wizardData.name || '').trim();
            const category = categoryEl ? categoryEl.value.trim() : (state.wizardData.category || '').trim();
            const description = descEl ? descEl.value.trim() : (state.wizardData.description || '').trim();
            const timeline = timelineEl ? timelineEl.value : (state.wizardData.timeline || '');
            return Boolean(name && category && description && timeline);
        }

        function renderWizardSteps() {
            const isStep1 = state.wizardStep === 1;
            const step1Done = isStep1Complete();
            const step1Icon = step1Done
                ? '<i class="fas fa-check"></i>'
                : '<i class="fas fa-edit"></i>';
            const step1Style = step1Done
                ? 'background: #22c55e; color: white; box-shadow: 0 6px 16px rgba(34,197,94,.25);'
                : (isStep1 ? 'background: var(--primary-blue); color: white; box-shadow: 0 6px 16px rgba(0,116,193,.25);' : 'background: #e5e7eb; color:#4b5563;');

            const stepsHtml = `
                <div style="display:flex; align-items:center; gap: 1rem; max-width: 900px; margin: 0 auto;">
                    <!-- Step 1 -->
                    <div style="display:flex; align-items:center; gap: 0.75rem;">
                        <div style="flex-shrink:0; display:flex; align-items:center; justify-content:center; width:48px; height:48px; border-radius:9999px; ${step1Style}">
                            ${step1Icon}
                        </div>
                        <div style="line-height:1.2;">
                            <div style="font-size: 0.8rem; color: #94a3b8;">Step 1</div>
                            <div style="font-weight:700; ${isStep1 ? 'color: var(--primary-blue);' : 'color:#475569;'}">Define Project</div>
                        </div>
                    </div>

                    <!-- Connector -->
                    <div aria-hidden="true" style="flex:1; border-top:2px dashed ${step1Done ? '#bbf7d0' : '#cbd5e1'}; margin: 0 0.5rem;"></div>

                    <!-- Step 2 -->
                    <div style="display:flex; align-items:center; gap: 0.75rem; opacity:${isStep1 ? 0.6 : 1};">
                        <div style="flex-shrink:0; display:flex; align-items:center; justify-content:center; width:48px; height:48px; border-radius:9999px; ${!isStep1 ? 'background: var(--primary-blue); color: white; box-shadow: 0 6px 16px rgba(0,116,193,.25);' : 'background: #e5e7eb; color:#64748b;'}">
                            <i class="fas fa-users"></i>
                        </div>
                        <div style="line-height:1.2;">
                            <div style="font-size: 0.8rem; color: #94a3b8;">Step 2</div>
                            <div style="font-weight:${!isStep1 ? '700':'600'}; ${!isStep1 ? 'color: var(--primary-blue);' : 'color:#64748b;'}">Assign AI Agents</div>
                        </div>
                    </div>
                </div>`;
            document.getElementById('wizardSteps').innerHTML = stepsHtml;
        }

        function renderWizard() {
            renderWizardSteps();
            if (state.wizardStep === 1) {
                renderWizardStep1();
            } else {
                renderWizardStep2();
            }
        }

        function renderWizardStep1() {
            // Initialize categories array if not exists
            if (!state.wizardData.categories) {
                state.wizardData.categories = state.wizardData.category ? [state.wizardData.category] : [];
            }
            // Initialize uploaded files array if not exists
            if (!state.wizardData.uploadedFiles) {
                state.wizardData.uploadedFiles = [];
            }

            document.getElementById('wizardContent').innerHTML = `
                <div style="max-width: 900px; margin: 0 auto;">
                    <div class="card" style="width: 100%;">
                         <div style="padding: 2rem;">
                            <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; color: var(--text-primary);">Define Your Project</h3>
                            <form id="wizardForm1" style="display:flex; flex-direction:column; gap: 1.25rem;">
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-weight:600; color: var(--text-primary); margin-bottom: .35rem;">Project Name <span style="color:#b91c1c; font-weight:700;">*</span></label>
                                    <input type="text" class="form-input" id="projectName" placeholder="e.g., Q4 Marketing Campaign Analyzer" value="${state.wizardData.name || ''}" required oninput="step1LiveUpdate()">
                                </div>
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-weight:600; color: var(--text-primary); margin-bottom: .35rem;">Project Categories <span style="color:#b91c1c; font-weight:700;">*</span></label>
                                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 0.5rem; background: #fff; min-height: 44px;">
                                        <div id="categoryTags" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            ${(state.wizardData.categories || []).map((cat, idx) => `
                                                <span class="tag" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem; background: var(--primary-blue); color: white; border-radius: 6px; font-size: 0.875rem; font-weight: 500;">
                                                    ${cat}
                                                    <i class="fas fa-times" onclick="removeCategory(${idx})" style="cursor: pointer; font-size: 0.75rem; opacity: 0.9;" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.9'"></i>
                                                </span>
                                            `).join('')}
                                        </div>
                                        <input type="text" class="form-input" id="categoryInput" placeholder="Type a category and press Enter" style="border: none; padding: 0.25rem 0.5rem; margin: 0;" onkeydown="handleCategoryInput(event)">
                                    </div>
                                    <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">Add multiple categories by typing and pressing Enter</p>
                                </div>
                                <!-- Project Timeline - Radio Group -->
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-weight:600; color: var(--text-primary); margin-bottom: .35rem;">Project Timeline <span style="color:#b91c1c; font-weight:700;">*</span></label>
                                    <div style="display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; border:1px solid var(--border-color); border-radius: 8px; padding: .5rem .75rem; background: #fff;">
                                        <label class="checkbox-item" style="margin: 0;">
                                             <input type="radio" name="projectTimeline" value="0-2y" ${state.wizardData.timeline === '0-2y' ? 'checked' : ''} onchange="step1LiveUpdate()">
                                             <div style="flex: none;">0 to 2 Years</div>
                                         </label>
                                        <label class="checkbox-item" style="margin: 0;">
                                             <input type="radio" name="projectTimeline" value="2-5y" ${state.wizardData.timeline === '2-5y' ? 'checked' : ''} onchange="step1LiveUpdate()">
                                             <div style="flex: none;">2 to 5 Years</div>
                                         </label>
                                        <label class="checkbox-item" style="margin: 0;">
                                             <input type="radio" name="projectTimeline" value="5-10y" ${state.wizardData.timeline === '5-10y' ? 'checked' : ''} onchange="step1LiveUpdate()">
                                             <div style="flex: none;">5 to 10 Years</div>
                                         </label>
                                        <label class="checkbox-item" style="margin: 0;">
                                             <input type="radio" name="projectTimeline" value="other" ${state.wizardData.timeline === 'other' ? 'checked' : ''} onchange="step1LiveUpdate()">
                                             <div style="flex: none;">Other</div>
                                         </label>
                                     </div>
                                 </div>
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-weight:600; color: var(--text-primary); margin-bottom: .35rem;">Project Description <span style="color:#b91c1c; font-weight:700;">*</span></label>
                                    <textarea class="form-textarea" id="projectDescription" placeholder="Describe the main objectives and goals of your project..." required style="min-height: 96px; height: 96px;" oninput="step1LiveUpdate()">${state.wizardData.description || ''}</textarea>
                                 </div>
                                <!-- File Upload Section -->
                                <div class="form-group" style="margin:0;">
                                    <label class="form-label" style="font-weight:600; color: var(--text-primary); margin-bottom: .35rem;">Project Documents</label>
                                    <div style="border: 2px dashed var(--border-color); border-radius: 8px; padding: 1.5rem; text-align: center; background: #fafbfc; transition: all 0.2s;" id="fileUploadArea" onmouseover="this.style.borderColor='var(--primary-blue)'; this.style.background='#f0f4ff'" onmouseout="this.style.borderColor='var(--border-color)'; this.style.background='#fafbfc'">
                                        <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.ppt,.pptx" style="display: none;" onchange="handleFileUpload(event)">
                                        <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 0.5rem; display: block;"></i>
                                        <p style="margin: 0.5rem 0; color: var(--text-primary); font-weight: 500;">Click to upload or drag and drop</p>
                                        <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary);">PDF, DOCX, PPT (Max 10 files, preferably PDF)</p>
                                        <button type="button" class="btn btn-outline" style="margin-top: 1rem; min-width: 120px;" onclick="document.getElementById('fileInput').click()">
                                            <i class="fas fa-upload"></i> Choose Files
                                        </button>
                                    </div>
                                    <div id="uploadedFilesList" style="margin-top: 1rem;">
                                        ${(state.wizardData.uploadedFiles || []).map((file, idx) => `
                                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border: 1px solid var(--border-color); border-radius: 6px; margin-bottom: 0.5rem;">
                                                <div style="display: flex; align-items: center; gap: 0.75rem;">
                                                    <i class="fas fa-file-${file.type === 'pdf' ? 'pdf' : file.type === 'docx' || file.type === 'doc' ? 'word' : 'powerpoint'}" style="color: ${file.type === 'pdf' ? '#dc2626' : file.type === 'docx' || file.type === 'doc' ? '#2563eb' : '#f59e0b'}; font-size: 1.25rem;"></i>
                                                    <div>
                                                        <div style="font-weight: 500; color: var(--text-primary); font-size: 0.9rem;">${file.name}</div>
                                                        <div style="font-size: 0.75rem; color: var(--text-secondary);">${(file.size / 1024).toFixed(1)} KB</div>
                                                    </div>
                                                </div>
                                                <i class="fas fa-times" onclick="removeFile(${idx})" style="color: var(--text-secondary); cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.background='#fee2e2'; this.style.color='var(--danger-red)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-secondary)'"></i>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${(state.wizardData.uploadedFiles || []).length >= 10 ? '<p style="font-size: 0.8rem; color: #dc2626; margin-top: 0.5rem;">Maximum 10 files reached</p>' : `<p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem;">${(state.wizardData.uploadedFiles || []).length}/10 files uploaded</p>`}
                                </div>
                             </form>
                         </div>
                     </div>
                 </div>
             `;

            document.getElementById('wizardFooter').innerHTML = `
                <div style="display:flex;gap:1rem;align-items:center; padding-top: .5rem;">
                    <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
                    <button class="btn btn-outline" onclick="saveDraftAndClose()">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                </div>
                <button class="btn btn-primary" style="min-width:160px" onclick="wizardNext(1)">Next: Assign AI Agents <i class="fas fa-arrow-right"></i></button>
            `;
        }

        function renderWizardStep2() {
            // Foundational AI Agents (Core 15)
            const foundationalAgents = [
                { id: 1, name: 'Alex Carter', role: 'Contrarian Thinker', avatar: '👤', description: ['Questions what everyone else assumes is true.', 'Finds risks hiding in plain sight.', 'Reveals opportunities others overlook.', 'Challenges your thinking to make it stronger.'] },
                { id: 2, name: 'Alexander Petrov', role: 'Business Models Strategist', avatar: '👤', description: ['Invents new ways to create and capture value.', 'Shows how to make ideas financially viable.', 'Designs platforms that grow exponentially.', 'Turns innovation into sustainable revenue.'] },
                { id: 3, name: 'Ayu Laksmi', role: 'Behavioral Economics Expert', avatar: '👤', description: ['Designs around how people really decide.', 'Makes good choices feel easy and natural.', 'Creates incentives that actually work.', 'Turns insights about behavior into action.'] },
                { id: 4, name: 'Chen Wei', role: 'Systems Complexity Advisor', avatar: '👤', description: ['Shows how everything connects to everything.', 'Finds small moves with huge impact.', 'Predicts ripple effects others miss.', 'Reveals hidden risks and opportunities.'] },
                { id: 5, name: 'Diego Morales', role: 'Global Innovation Director', avatar: '👤', description: ['Finds opportunities others completely miss.', 'Creates new markets instead of competing.', 'Turns breakthrough ideas into real products.', 'Shows exactly how to build and scale.'] },
                { id: 6, name: 'Fatima Al-Hassan', role: 'International Best Practices Expert', avatar: '👤', description: ['Finds what actually works across countries.', 'Adapts global successes to local realities.', 'Reveals why some approaches succeed.', 'Customizes proven models for your context.'] },
                { id: 7, name: 'Hiro Tanaka', role: 'Science Fiction Scholar', avatar: '👤', description: ['Mines science fiction for real solutions.', 'Builds working prototypes from bold ideas.', 'Tests radical concepts through storytelling.', 'Bridges imagination with technical design.'] },
                { id: 8, name: 'Lars Nyström', role: 'Strategic Scenarios Expert', avatar: '👤', description: ['Plans for multiple possible futures at once.', 'Shows when to act as situations unfold.', 'Prepares you for surprising changes.', 'Builds strategies that work in any scenario.'] },
                { id: 9, name: 'Mariam Okoye', role: 'Global Futures Strategist', avatar: '👤', description: ['Spots major shifts before others see them.', 'Turns 30-year visions into quarterly plans.', 'Maps how today\'s choices shape tomorrow.', 'Predicts changes that redefine the future.'] },
                { id: 10, name: 'Omar Khan', role: 'Global Finance Strategist', avatar: '👤', description: ['Unlocks funding for ambitious projects.', 'Structures deals that attract investors.', 'Makes development goals financially viable.', 'Shows exactly how to raise the capital.'] },
                { id: 11, name: 'Park Mi-kyung', role: 'Implementation Specialist', avatar: '👤', description: ['Turns big ideas into step-by-step plans.', 'Shows exactly who does what and when.', 'Scales solutions while keeping quality.', 'Adjusts plans as you learn what works.'] },
                { id: 12, name: 'Priya Ramanathan', role: 'AI Transformation Advisor', avatar: '👤', description: ['Designs AI that amplifies human capabilities.', 'Spots AI hype vs real opportunities.', 'Maps practical automation roadmaps.', 'Ensures AI systems work fairly for all.'] },
                { id: 13, name: 'Robert Whitaker', role: 'Ethics and Equity Advisor', avatar: '👤', description: ['Ensures solutions benefit everyone fairly.', 'Spots and fixes bias before it causes harm.', 'Designs equity in from the start.', 'Makes innovation work for the vulnerable.'] },
                { id: 14, name: 'Sophie Dubois', role: 'Weak Signals Analyst', avatar: '👤', description: ['Catches emerging changes years early.', 'Spots patterns before they become trends.', 'Tells you when to move first.', 'Identifies tomorrow\'s game-changers today.'] },
                { id: 15, name: 'Zuri Kamau', role: 'Risk and Resilience Advisor', avatar: '👤', description: ['Builds systems that get stronger from shocks.', 'Spots vulnerabilities before they hurt you.', 'Designs plans that survive disruption.', 'Prepares you for the unexpected.'] }
            ];

            // Contextual AI Agents (Project-specific, 3 new agents)
            const contextualAgents = [
                { id: 16, name: 'Climate Tech Specialist', role: 'Environmental Tech', avatar: '🌍', description: ['Analyzes carbon reduction technologies', 'Evaluates renewable energy solutions', 'Assesses climate impact metrics', 'Recommends sustainable practices'] },
                { id: 17, name: 'Industry Domain Expert', role: 'Sector Specialist', avatar: '🏢', description: ['Provides industry-specific insights', 'Analyzes sector trends and dynamics', 'Evaluates competitive positioning', 'Recommends best practices'] },
                { id: 18, name: 'Regional Market Advisor', role: 'Geographic Expert', avatar: '🌐', description: ['Analyzes regional market conditions', 'Evaluates cultural considerations', 'Assesses local regulations', 'Recommends localization strategies'] }
            ];

            // Initialize selectedAI array if not exists
            if (!state.wizardData.selectedAI) {
                state.wizardData.selectedAI = [];
            }

            // Check if foundational agents section should be visible
            const showFoundational = state.wizardData.showFoundationalAgents || false;

            document.getElementById('wizardContent').innerHTML = `
                <div class="card">
                    <h3 style="display: flex; align-items: center; margin-bottom: 1.5rem;">
                        <span class="title-bar"></span>
                        Assign AI Agents
                    </h3>
                    <p class="text-muted" style="margin-bottom: 2.5rem;">Select AI agents to deploy for this project. They will generate ideas and participate in voting based on their expertise.</p>
                    
                    <!-- Contextual AI Agents Section (Shown First) -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-project-diagram" style="color: #8a2be2;"></i>
                            Contextual AI Agents
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                            ${contextualAgents.map(agent => `
                                <div class="agent-card ${state.wizardData.selectedAI?.includes(agent.id) ? 'selected' : ''}" role="checkbox" aria-checked="${state.wizardData.selectedAI?.includes(agent.id) ? 'true' : 'false'}" tabindex="0" onclick="toggleAIAgentCard(${agent.id})" onkeydown="if(event.key===' '||event.key==='Enter'){event.preventDefault();toggleAIAgentCard(${agent.id})}" style="background: white; border: 2px solid ${state.wizardData.selectedAI?.includes(agent.id) ? 'var(--primary-blue)' : 'var(--border-color)'}; border-radius: 8px; padding: 0.9rem; cursor: pointer; transition: all 0.2s; position: relative; min-height:0;">
                                    <!-- Checkbox -->
                                    <input type="checkbox" ${state.wizardData.selectedAI?.includes(agent.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleAIAgentCard(${agent.id})" style="position: absolute; top: 1rem; left: 1rem; width: 18px; height: 18px; cursor: pointer;">
                                    
                                    <!-- Agent Avatar -->
                                    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
                                        <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #FF6B6B 0%, #ee5a6f 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 0.75rem;">
                                            ${agent.avatar}
                                        </div>
                                        <div style="text-align: center;">
                                            <strong style="font-size: 1rem; color: var(--text-primary); display: block;">${agent.name}</strong>
                                            <span style="font-size: 0.85rem; color: var(--text-secondary);">${agent.role}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Capabilities -->
                                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;" class="line-clamp-2">
                                        ${agent.description.slice(0,2).map(item => `<li style=\"margin-bottom: 0.25rem;\">• ${item}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Foundational AI Agents Section (Hidden by Default) -->
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <h4 style="font-size: 1.2rem; font-weight: 600; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem; margin: 0;">
                                <i class="fas fa-brain" style="color: var(--primary-blue);"></i>
                                Foundational AI Agents (${foundationalAgents.length})
                            </h4>
                            <button type="button" class="btn btn-outline" style="min-width: auto; padding: 0.4rem 0.75rem; font-size: 0.875rem;" onclick="toggleFoundationalAgents()">
                                <i class="fas fa-${showFoundational ? 'eye-slash' : 'eye'}"></i> ${showFoundational ? 'Hide' : 'Show'} Foundational Agents
                            </button>
                        </div>
                        <div id="foundationalAgentsContainer" style="display: ${showFoundational ? 'grid' : 'none'}; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                            ${foundationalAgents.map(agent => `
                                <div class="agent-card ${state.wizardData.selectedAI?.includes(agent.id) ? 'selected' : ''}" role="checkbox" aria-checked="${state.wizardData.selectedAI?.includes(agent.id) ? 'true' : 'false'}" tabindex="0" onclick="toggleAIAgentCard(${agent.id})" onkeydown="if(event.key===' '||event.key==='Enter'){event.preventDefault();toggleAIAgentCard(${agent.id})}" style="background: white; border: 2px solid ${state.wizardData.selectedAI?.includes(agent.id) ? 'var(--primary-blue)' : 'var(--border-color)'}; border-radius: 8px; padding: 0.9rem; cursor: pointer; transition: all 0.2s; position: relative; min-height:0;">
                                    <!-- Checkbox -->
                                    <input type="checkbox" ${state.wizardData.selectedAI?.includes(agent.id) ? 'checked' : ''} onclick="event.stopPropagation(); toggleAIAgentCard(${agent.id})" style="position: absolute; top: 1rem; left: 1rem; width: 18px; height: 18px; cursor: pointer;">
                                    
                                    <!-- Agent Avatar -->
                                    <div style="display: flex; flex-direction: column; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem;">
                                        <div style="width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-bottom: 0.75rem;">
                                            ${agent.avatar}
                                        </div>
                                        <div style="text-align: center;">
                                            <strong style="font-size: 1rem; color: var(--text-primary); display: block;">${agent.name}</strong>
                                            <span style="font-size: 0.85rem; color: var(--text-secondary);">${agent.role}</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Capabilities -->
                                    <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;" class="line-clamp-2">
                                        ${agent.description.slice(0,2).map(item => `<li style=\"margin-bottom: 0.25rem;\">• ${item}</li>`).join('')}
                                    </ul>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            const canFinish = (state.wizardData.selectedAI && state.wizardData.selectedAI.length > 0);
            document.getElementById('wizardFooter').innerHTML = `
                <div style="display:flex;gap:1rem;align-items:center;">
                    <button class="btn btn-secondary" onclick="wizardBack(2)">
                        <i class="fas fa-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-outline" onclick="saveDraftAndClose()">
                        <i class="fas fa-save"></i> Save as Draft
                    </button>
                </div>
                ${canFinish ? `
                <button class="btn btn-primary" style="min-width:160px" onclick="wizardNext(2)">
                    <i class="fas fa-check"></i> Finish & Generate Ideas
                </button>` : `
                <div class="text-muted" style="padding: .5rem 1rem;">Select at least one agent to continue</div>`}
            `;
        }

        function toggleAIAgentCard(agentId) {
            if (!state.wizardData.selectedAI) {
                state.wizardData.selectedAI = [];
            }
            
            const index = state.wizardData.selectedAI.indexOf(agentId);
            if (index > -1) {
                state.wizardData.selectedAI.splice(index, 1);
            } else {
                state.wizardData.selectedAI.push(agentId);
            }
            
            renderWizardStep2();
        }

        function handleCategoryInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const category = input.value.trim();
                if (category && category.length > 0) {
                    if (!state.wizardData.categories) {
                        state.wizardData.categories = [];
                    }
                    if (!state.wizardData.categories.includes(category)) {
                        state.wizardData.categories.push(category);
                        input.value = '';
                        step1LiveUpdate();
                        renderWizardStep1();
                    } else {
                        showToast('Category already exists', 'error');
                    }
                }
            }
        }

        function removeCategory(index) {
            if (state.wizardData.categories) {
                state.wizardData.categories.splice(index, 1);
                step1LiveUpdate();
                renderWizardStep1();
            }
        }

        function handleFileUpload(event) {
            const files = Array.from(event.target.files);
            if (!state.wizardData.uploadedFiles) {
                state.wizardData.uploadedFiles = [];
            }
            
            const currentCount = state.wizardData.uploadedFiles.length;
            const remainingSlots = 10 - currentCount;
            
            if (files.length > remainingSlots) {
                showToast(`Maximum 10 files allowed. You can add ${remainingSlots} more file(s).`, 'error');
                files.splice(remainingSlots);
            }
            
            files.forEach(file => {
                const fileExtension = file.name.split('.').pop().toLowerCase();
                const allowedTypes = ['pdf', 'doc', 'docx', 'ppt', 'pptx'];
                
                if (!allowedTypes.includes(fileExtension)) {
                    showToast(`File "${file.name}" is not a supported format. Please upload PDF, DOCX, or PPT files.`, 'error');
                    return;
                }
                
                const fileType = fileExtension === 'pdf' ? 'pdf' : (fileExtension === 'doc' || fileExtension === 'docx' ? 'docx' : 'ppt');
                
                state.wizardData.uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    type: fileType,
                    file: file // Store the actual file object
                });
            });
            
            event.target.value = ''; // Reset input
            renderWizardStep1();
        }

        function removeFile(index) {
            if (state.wizardData.uploadedFiles) {
                state.wizardData.uploadedFiles.splice(index, 1);
                renderWizardStep1();
            }
        }

        function toggleFoundationalAgents() {
            state.wizardData.showFoundationalAgents = !state.wizardData.showFoundationalAgents;
            renderWizardStep2();
        }

        function step1LiveUpdate() {
            // Update wizard data in real-time for validation
            const nameEl = document.getElementById('projectName');
            const descEl = document.getElementById('projectDescription');
            const timelineEl = document.querySelector('input[name="projectTimeline"]:checked');
            
            if (nameEl) state.wizardData.name = nameEl.value;
            if (descEl) state.wizardData.description = descEl.value;
            if (timelineEl) state.wizardData.timeline = timelineEl.value;
            
            // Update stepper icon based on completion
            renderWizardSteps();
        }

        function saveDraftAndClose() {
            // Read current form values if present
            const nameEl = document.getElementById('projectName');
            const descEl = document.getElementById('projectDescription');
            const timelineEl = document.querySelector('input[name="projectTimeline"]:checked');
            if (!state.wizardData) state.wizardData = {};
            if (nameEl) state.wizardData.name = nameEl.value;
            // Categories are already stored in state.wizardData.categories
            if (descEl) state.wizardData.description = descEl.value;
            if (timelineEl) state.wizardData.timeline = timelineEl.value;

            // Save draft (no validation, always enabled)
            const draftIndex = state.draftProjects.findIndex(d => d.draftId === state.wizardData.draftId);
            const draft = { ...state.wizardData, draftId: state.wizardData.draftId || Date.now() };
            if (draftIndex > -1) {
                state.draftProjects[draftIndex] = draft;
            } else {
                state.draftProjects.push(draft);
            }

            showToast('✓ Draft saved successfully', 'success');
            // Stay on current step; do not close wizard
            renderWizardSteps();
        }

        function wizardNext(step) {
            if (step === 1) {
                const name = document.getElementById('projectName').value;
                const categories = state.wizardData.categories || [];
                const description = document.getElementById('projectDescription').value;
                const timelineInput = document.querySelector('input[name="projectTimeline"]:checked');
                
                if (!name || categories.length === 0 || !description || !timelineInput) {
                    showToast('Please fill in all required fields. At least one category is required.', 'error');
                    return;
                }
                
                state.wizardData.name = name;
                state.wizardData.categories = categories;
                state.wizardData.category = categories.join(', '); // Keep for backward compatibility
                state.wizardData.description = description;
                state.wizardData.timeline = timelineInput.value;
                state.wizardStep = 2;
            } else if (step === 2) {
                // Finalize from Step 2
                finishProjectWizard();
                return;
            }
            
            renderWizard();
        }

        function wizardBack(step) {
            state.wizardStep = step - 1;
            renderWizard();
        }

        function closeWizard() {
            document.getElementById('wizard').classList.remove('active');
            state.wizardData = {};
        }

        function addParticipantInWizard() {
            const firstName = document.getElementById('wizardFirstName').value.trim();
            const lastName = document.getElementById('wizardLastName').value.trim();
            const email = document.getElementById('wizardEmail').value.trim();
            const plan = document.getElementById('wizardPlan').value;
            
            if (!firstName || !lastName || !email || !plan) {
                showToast('Please fill in all fields to add a participant', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            if (!state.wizardData.invitedParticipants) {
                state.wizardData.invitedParticipants = [];
            }
            
            // Check for duplicate
            if (state.wizardData.invitedParticipants.some(p => p.email === email)) {
                showToast('This participant has already been added', 'error');
                return;
            }
            
            const participant = {
                name: `${firstName} ${lastName}`,
                email: email,
                plan: plan
            };
            
            state.wizardData.invitedParticipants.push(participant);
            
            // Clear form
            document.getElementById('wizardFirstName').value = '';
            document.getElementById('wizardLastName').value = '';
            document.getElementById('wizardEmail').value = '';
            document.getElementById('wizardPlan').value = '';
            
            // Focus back to first field for quick multiple adds
            document.getElementById('wizardFirstName').focus();
            
            showToast(`✓ ${participant.name} added to invitation list`, 'success');
            renderWizardStep3();
        }

        function removeParticipantFromWizard(index) {
            if (!confirm('Remove this participant from the invitation list?')) {
                return;
            }
            
            const removed = state.wizardData.invitedParticipants.splice(index, 1)[0];
            showToast(`Removed ${removed.name} from invitation list`, 'info');
            renderWizardStep3();
        }

        function showInviteHumansForIdeas() {
            showToast('Invitation emails will be sent when project is created', 'info');
        }

        function showInviteHumansToIdeas() {
            showModal(
                '<i class="fas fa-user-plus"></i> Invite Humans to Submit Ideas',
                `
                    <p class="text-muted" style="margin-bottom: 1.5rem;">Invite team members or external participants to contribute ideas to <strong>${state.currentProject.name}</strong></p>
                    
                    <div class="info-box" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-info-circle"></i> Invited participants will receive an email with instructions to submit their ideas for this project.
                    </div>

                    <form id="inviteIdeasForm">
                        <!-- Row 1: Name and Email -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-input" id="ideaInviteFirstName" placeholder="First name" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-input" id="ideaInviteLastName" placeholder="Last name" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="ideaInviteEmail" placeholder="Email address" required>
                            </div>
                        </div>
                        
                        <!-- Row 2: Message (Optional) -->
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label">Invitation Message (Optional)</label>
                            <textarea class="form-textarea" id="ideaInviteMessage" placeholder="Add a personal message to the invitation..." style="min-height: 100px;"></textarea>
                        </div>
                    </form>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="sendIdeaInvitation()">
                        <i class="fas fa-paper-plane"></i> Send Invitation
                    </button>
                `
            );
        }

        function sendIdeaInvitation() {
            const firstName = document.getElementById('ideaInviteFirstName').value;
            const lastName = document.getElementById('ideaInviteLastName').value;
            const email = document.getElementById('ideaInviteEmail').value;
            
            if (!firstName || !lastName || !email) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            closeModal();
            showLoading('Sending invitation...');
            
            setTimeout(() => {
                hideLoading();
                showToast(`✓ Invitation sent to ${firstName} ${lastName} to submit ideas`, 'success');
                setTimeout(() => {
                    showToast(`📧 ${email} will receive an email with instructions`, 'info');
                }, 1200);
            }, 800);
        }

        function generateIdeasInWizard() {
            const ideasPerAgent = parseInt(document.getElementById('wizardIdeasPerAgent').value) || 3;
            
            if (!state.wizardData.selectedAI || state.wizardData.selectedAI.length === 0) {
                showToast('No AI agents selected', 'error');
                return;
            }
            
            showLoading(`Generating ${state.wizardData.selectedAI.length * ideasPerAgent} ideas...`);
            
            setTimeout(() => {
                if (!state.wizardData.generatedIdeas) {
                    state.wizardData.generatedIdeas = [];
                }
                
                const ideaTemplates = [
                    'Strategic Analysis', 'Risk Assessment', 'Innovation Proposal', 'Market Opportunity',
                    'Competitive Advantage', 'Process Optimization', 'Cost Reduction Strategy',
                    'Customer Value Enhancement', 'Technology Integration', 'Sustainability Initiative'
                ];
                
                state.wizardData.selectedAI.forEach((agentId, idx) => {
                    const agent = state.aiRoster.find(a => a.id === agentId);
                    for (let i = 0; i < ideasPerAgent; i++) {
                        state.wizardData.generatedIdeas.push({
                            title: `${ideaTemplates[(idx * ideasPerAgent + i) % ideaTemplates.length]} - ${agent.name}`,
                            content: `Expert insight from ${agent.name} based on ${agent.description}`,
                            source: 'ai',
                            agentName: agent.name
                        });
                    }
                });
                
                hideLoading();
                showToast(`✓ ${state.wizardData.generatedIdeas.length} ideas generated successfully!`, 'success');
                renderWizardStep4();
            }, 2000);
        }


        function showInviteModal() {
            showModal(
                '<i class="fas fa-user-plus"></i> Invite New Participant',
                `
                    <form id="inviteForm">
                        <!-- Row 1: Name and Email with Trash Icon -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 1rem; margin-bottom: 1.5rem;">
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">First Name *</label>
                                <input type="text" class="form-input" id="inviteFirstName" placeholder="First name" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">Last Name *</label>
                                <input type="text" class="form-input" id="inviteLastName" placeholder="Last name" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label class="form-label">Email *</label>
                                <input type="email" class="form-input" id="inviteEmail" placeholder="Email address" required>
                            </div>
                            <div style="display: flex; align-items: flex-end; padding-bottom: 0.5rem;">
                                <button type="button" class="btn" style="background: transparent; color: var(--text-secondary); padding: 0.6rem; border: none; cursor: pointer; transition: all 0.2s;" title="Remove" onmouseover="this.style.color='var(--danger-red)'" onmouseout="this.style.color='var(--text-secondary)'">
                                    <i class="fas fa-trash-alt" style="font-size: 1.2rem;"></i>
                                </button>
                            </div>
                        </div>
                        
                    </form>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="sendInvite()">
                        Save
                    </button>
                `
            );
        }

        function addAnotherUser() {
            showToast('Multiple user addition will be available in the next version', 'info');
        }

        function sendInvite() {
            const firstName = document.getElementById('inviteFirstName').value.trim();
            const lastName = document.getElementById('inviteLastName').value.trim();
            const email = document.getElementById('inviteEmail').value.trim();
            
            if (!firstName || !lastName || !email) {
                showToast('Please fill in all required fields (First Name, Last Name, Email)', 'error');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            // Check if email already exists
            if (state.teamMembers.some(m => m.email === email)) {
                showToast('This email is already in your team', 'error');
                return;
            }
            
            closeModal();
            showLoading('Sending invitation...');
            
            setTimeout(() => {
                const newMember = {
                    id: state.teamMembers.length + 100,
                    name: `${firstName} ${lastName}`,
                    email: email,
                    status: 'pending',
                    joinedDate: null
                };
                
                state.teamMembers.push(newMember);
                state.currentUser.licenses--;
                
                // Auto-add to current project if in wizard
                if (state.wizardData && state.wizardData.selectedTeam !== undefined) {
                    if (!state.wizardData.selectedTeam) {
                        state.wizardData.selectedTeam = [];
                    }
                    state.wizardData.selectedTeam.push(newMember.id);
                }
                
                hideLoading();
                updateMetrics();
                
                // Show success with details
                showToast(`✓ Invitation sent to ${firstName} ${lastName} (${email})`, 'success');
                
                // Show info about license consumption
                setTimeout(() => {
                    showToast(`📊 License consumed: ${state.currentUser.licenses} remaining`, 'info');
                }, 1500);
                
                // Re-render appropriate view
                if (state.wizardData && Object.keys(state.wizardData).length > 0) {
                    // In wizard context - re-render current step
                    if (state.wizardStep === 3) {
                        renderWizardStep3();
            } else {
                        render();
                    }
                } else {
                    render();
                }
            }, 800);
        }

        function finishProjectWizard() {
            showLoading('Creating your project...');
            
            // Extended AI roster matching the wizard (including contextual agents)
            const extendedAiRoster = [
                { id: 1, name: 'Alex Carter', role: 'Contrarian Thinker', description: 'Questions what everyone else assumes is true. Finds risks hiding in plain sight.' },
                { id: 2, name: 'Alexander Petrov', role: 'Business Models Strategist', description: 'Invents new ways to create and capture value. Shows how to make ideas financially viable.' },
                { id: 3, name: 'Ayu Laksmi', role: 'Behavioral Economics Expert', description: 'Designs around how people really decide. Makes good choices feel easy and natural.' },
                { id: 4, name: 'Chen Wei', role: 'Systems Complexity Advisor', description: 'Shows how everything connects to everything. Finds small moves with huge impact.' },
                { id: 5, name: 'Diego Morales', role: 'Global Innovation Director', description: 'Finds opportunities others completely miss. Creates new markets instead of competing.' },
                { id: 6, name: 'Fatima Al-Hassan', role: 'International Best Practices Expert', description: 'Finds what actually works across countries. Adapts global successes to local realities.' },
                { id: 7, name: 'Hiro Tanaka', role: 'Science Fiction Scholar', description: 'Mines science fiction for real solutions. Builds working prototypes from bold ideas.' },
                { id: 8, name: 'Lars Nyström', role: 'Strategic Scenarios Expert', description: 'Plans for multiple possible futures at once. Shows when to act as situations unfold.' },
                { id: 9, name: 'Mariam Okoye', role: 'Global Futures Strategist', description: 'Spots major shifts before others see them. Turns 30-year visions into quarterly plans.' },
                { id: 10, name: 'Omar Khan', role: 'Global Finance Strategist', description: 'Unlocks funding for ambitious projects. Structures deals that attract investors.' },
                { id: 11, name: 'Park Mi-kyung', role: 'Implementation Specialist', description: 'Turns big ideas into step-by-step plans. Shows exactly who does what and when.' },
                { id: 12, name: 'Priya Ramanathan', role: 'AI Transformation Advisor', description: 'Designs AI that amplifies human capabilities. Spots AI hype vs real opportunities.' },
                { id: 13, name: 'Robert Whitaker', role: 'Ethics and Equity Advisor', description: 'Ensures solutions benefit everyone fairly. Spots and fixes bias before it causes harm.' },
                { id: 14, name: 'Sophie Dubois', role: 'Weak Signals Analyst', description: 'Catches emerging changes years early. Spots patterns before they become trends.' },
                { id: 15, name: 'Zuri Kamau', role: 'Risk and Resilience Advisor', description: 'Builds systems that get stronger from shocks. Spots vulnerabilities before they hurt you.' },
                { id: 16, name: 'Climate Tech Specialist', role: 'Environmental Tech', description: 'Analyzes carbon reduction technologies' },
                { id: 17, name: 'Industry Domain Expert', role: 'Sector Specialist', description: 'Provides industry-specific insights' },
                { id: 18, name: 'Regional Market Advisor', role: 'Geographic Expert', description: 'Analyzes regional market conditions' }
            ];
            
            // Simulate project creation
            setTimeout(() => {
                const humanTeam = (state.wizardData.selectedTeam || []).map(id => 
                    state.teamMembers.find(m => m.id === id)
                );
                
                // Use selected agents (users can select/deselect any agents)
                if (!state.wizardData.selectedAI) {
                    state.wizardData.selectedAI = [];
                }
                
                const aiTeam = state.wizardData.selectedAI.map(id => 
                    extendedAiRoster.find(a => a.id === id)
                ).filter(a => a !== undefined);
                
                // Add invited participants to team members and human team
                if (state.wizardData.invitedParticipants && state.wizardData.invitedParticipants.length > 0) {
                    state.wizardData.invitedParticipants.forEach(participant => {
                        const newMember = {
                            id: state.teamMembers.length + 100 + Math.random(),
                            name: participant.name,
                            email: participant.email,
                            status: 'pending',
                            plan: participant.plan,
                            joinedDate: null
                        };
                        state.teamMembers.push(newMember);
                        humanTeam.push(newMember);
                        state.currentUser.licenses--;
                    });
                }
                
                // Generate 1 idea per selected agent
                const ideaTemplates = [
                    'Strategic Analysis', 'Innovation Proposal', 'Market Opportunity', 'Process Optimization', 'Customer Value Enhancement'
                ];
                const initialIdeas = (state.wizardData.selectedAI || []).map((agentId, idx) => {
                    const agent = extendedAiRoster.find(a => a.id === agentId);
                    return {
                        id: idx + 1,
                        title: `${ideaTemplates[idx % ideaTemplates.length]} - ${agent.name}`,
                        content: `Initial idea generated by ${agent.name} based on their expertise (${agent.role}).`,
                        submittedBy: agent.name,
                        source: 'ai',
                        category: getCategoryForAgent(agent),
                        submittedDate: new Date()
                    };
                });
                
                // Get purchase date from most recent purchase history entry
                const mostRecentPurchase = state.purchaseHistory.length > 0 
                    ? state.purchaseHistory.sort((a, b) => new Date(b.date) - new Date(a.date))[0]
                    : null;
                const purchaseDate = mostRecentPurchase ? mostRecentPurchase.date : null;
                
                const newProject = {
                    id: state.projects.length + 1,
                    name: state.wizardData.name,
                    category: state.wizardData.categories ? state.wizardData.categories.join(', ') : (state.wizardData.category || ''),
                    categories: state.wizardData.categories || (state.wizardData.category ? [state.wizardData.category] : []),
                    timeline: state.wizardData.timeline,
                    description: state.wizardData.description,
                    uploadedFiles: state.wizardData.uploadedFiles || [],
                    purchaseDate: purchaseDate,
                    owner: state.currentUser.name,
                    created: new Date(),
                    status: 'active',
                    humanTeam: humanTeam,
                    aiTeam: aiTeam,
                    ideas: initialIdeas,
                    votingSessions: []
                };
                
                state.projects.push(newProject);
                state.currentProject = newProject;
                
                closeWizard();
                hideLoading();
                updateMetrics();
                
                // Direct navigation without extra modal
                state.projectActiveTab = 'ideas';
                showToast(`✓ "${newProject.name}" created with ${aiTeam.length} agent(s), ${initialIdeas.length} idea(s)`, 'success');
                navigateTo('workspace', 'project-detail');
            }, 1000);
        }

        // Project Actions
        function viewProject(projectId) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            // Default to 'users' tab (first in new order)
            state.projectActiveTab = 'users';
            navigateTo('workspace', 'project-detail');
        }

        function downloadFile(fileName, fileIndex) {
            const project = state.currentProject;
            if (!project || !project.uploadedFiles || !project.uploadedFiles[fileIndex]) {
                showToast('File not found', 'error');
                return;
            }
            
            const file = project.uploadedFiles[fileIndex];
            
            // If file object exists (from File API), create download link
            if (file.file && file.file instanceof File) {
                const url = URL.createObjectURL(file.file);
                const a = document.createElement('a');
                a.href = url;
                a.download = file.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast(`✓ Downloading ${file.name}`, 'success');
            } else {
                // For demo purposes, simulate download
                showToast(`✓ Download started: ${file.name}`, 'success');
                // In a real application, you would make an API call to download the file
            }
        }

        function showManualIdeaForm() {
            showModal(
                '<i class="fas fa-lightbulb"></i> Add Idea Manually',
                `
                    <form id="manualIdeaForm">
                        <div class="form-group">
                            <label class="form-label">Idea Title *</label>
                            <input type="text" class="form-input" id="manualIdeaTitle" placeholder="Enter a descriptive title for your idea" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Idea Category *</label>
                            <input type="text" class="form-input" id="manualIdeaCategory" placeholder="e.g., Innovation, Process Improvement, Customer Experience" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Idea Description *</label>
                            <textarea class="form-textarea" id="manualIdeaContent" placeholder="Describe your idea in detail, including benefits and implementation approach..." required style="min-height: 120px;"></textarea>
                        </div>
                        <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 0;">
                            <div>
                                <label class="form-label">Author First Name *</label>
                                <input type="text" class="form-input" id="manualIdeaFirstName" placeholder="First name" required>
                            </div>
                            <div>
                                <label class="form-label">Author Last Name *</label>
                                <input type="text" class="form-input" id="manualIdeaLastName" placeholder="Last name" required>
                            </div>
                        </div>
                    </form>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="addManualIdea()">
                        <i class="fas fa-plus"></i> Add Idea
                    </button>
                `
            );
        }

        function addManualIdea() {
            const title = document.getElementById('manualIdeaTitle').value.trim();
            const category = document.getElementById('manualIdeaCategory').value.trim();
            const content = document.getElementById('manualIdeaContent').value.trim();
            const firstName = document.getElementById('manualIdeaFirstName').value.trim();
            const lastName = document.getElementById('manualIdeaLastName').value.trim();
            
            if (!title || !category || !content || !firstName || !lastName) {
                showToast('Please fill in all required fields', 'error');
                return;
            }
            
            closeModal();
            showLoading('Adding your idea...');
            
            setTimeout(() => {
                const authorName = `${firstName} ${lastName}`;
                const newIdea = {
                    id: state.currentProject.ideas.length + 1,
                    title: title,
                    category: category,
                    content: content,
                    submittedBy: authorName,
                    source: 'human',
                    submittedDate: new Date()
                };
                
                state.currentProject.ideas.push(newIdea);
                
                hideLoading();
                showToast(`✓ Idea "${title}" added successfully by ${authorName}!`, 'success');
                render();
            }, 500);
        }

        function showAllAgentsModal() {
            showModal(
                '<i class="fas fa-users-cog"></i> All AI Agents - Generate Ideas',
                `
                    <div class="info-box" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-info-circle"></i> Browse all available AI agents and select those you'd like to generate ideas for your project. Each agent brings unique expertise and perspectives.
                    </div>
                    
                    <!-- All AI Agents Listing -->
                    <div style="background: white; border: 1px solid var(--border-color); border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); max-height: 500px; overflow-y: auto;">
                        ${state.aiRoster.map((agent, idx) => `
                            <label style="display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem 2rem; ${idx < state.aiRoster.length - 1 ? 'border-bottom: 1px solid #f0f2f5;' : ''} transition: all 0.2s; background: white; cursor: pointer;" onmouseover="this.style.background='#fafbfd'" onmouseout="this.style.background='white'">
                                <!-- Checkbox -->
                                <input type="checkbox" value="${agent.id}" class="all-ai-generator-checkbox" style="width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                                
                                <!-- Agent Avatar/Icon -->
                                <div style="width: 48px; height: 48px; border-radius: 8px; background: linear-gradient(135deg, #8a2be2, #6a1bb2); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                                    🤖
                                </div>
                                
                                <!-- Name and Description -->
                                <div style="flex: 1; min-width: 0;">
                                    <strong style="font-size: 1.05rem; color: var(--text-primary); display: block; margin-bottom: 0.25rem;">${agent.name}</strong>
                                    <p style="color: var(--text-secondary); margin: 0; font-size: 0.9rem;">${agent.description}</p>
                                </div>
                                
                                <!-- Role Badge -->
                                <div style="flex-shrink: 0;">
                                    <span style="display: inline-block; padding: 0.45rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; background: #e8daef; color: #6c3483;">
                                        ${agent.role || 'AI Agent'}
                                    </span>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="form-group" style="margin-top: 1.5rem; margin-bottom: 0;">
                        <label class="form-label">Number of ideas per agent</label>
                        <input type="number" class="form-input" id="allIdeasPerAgent" value="3" min="1" max="10">
                    </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="generateIdeasFromAllAgents()">
                        <i class="fas fa-magic"></i> Generate Ideas
                    </button>
                `
            );
        }

        function showAIGenerateModal() {
            if (state.currentProject.aiTeam.length === 0) {
                showToast('No AI agents deployed to this project yet. Try "Generate Idea with Agents" to see all available agents.', 'error');
                return;
            }

            showModal(
                '<i class="fas fa-robot"></i> Generate Ideas with Deployed AI',
                `
                    <div class="info-box" style="margin-bottom: 1.5rem;">
                        <i class="fas fa-robot"></i> Select which deployed AI agents should generate ideas for this project. Each agent will contribute based on their unique expertise.
                    </div>
                    
                    <!-- Agent Selection Grid -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem; max-height: 400px; overflow-y: auto;">
                        ${state.currentProject.aiTeam.map(agent => `
                            <label style="background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s; display: flex; gap: 0.75rem; align-items: start;">
                                <input type="checkbox" value="${agent.id}" class="ai-generator-checkbox" style="margin-top: 0.25rem; width: 18px; height: 18px; cursor: pointer;">
                                <div style="flex: 1;">
                                    <strong style="display: block; font-size: 1rem; color: var(--text-primary); margin-bottom: 0.25rem;">${agent.name}</strong>
                                    <span style="display: block; font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">${agent.role || 'AI Expert'}</span>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0; line-height: 1.4;">${agent.description}</p>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">Number of ideas per agent</label>
                        <input type="number" class="form-input" id="ideasPerAgent" value="3" min="1" max="10">
                    </div>
                `,
                `
                    <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="generateAIIdeas()">
                        <i class="fas fa-magic"></i> Generate Ideas
                    </button>
                `
            );
        }

        function generateIdeasFromAllAgents() {
            const selectedAgents = Array.from(document.querySelectorAll('.all-ai-generator-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedAgents.length === 0) {
                showToast('Please select at least one AI agent.', 'error');
                return;
            }
            
            const ideasPerAgent = parseInt(document.getElementById('allIdeasPerAgent').value);
            const totalIdeas = selectedAgents.length * ideasPerAgent;
            
            closeModal();
            showLoading(`AI agents are generating ${totalIdeas} ideas...`);
            
            // AI idea templates
            const ideaTemplates = {
                1: ['Risk Mitigation Strategy', 'Compliance Framework Enhancement', 'Vulnerability Assessment Protocol'],
                2: ['Alternative Approach Analysis', 'Challenge to Current Assumptions', 'Devil\'s Advocate Perspective'],
                3: ['Emerging Technology Integration', 'Innovation Roadmap Proposal', 'Disruptive Solution Concept'],
                4: ['Ethical Impact Assessment', 'Privacy-First Implementation', 'Inclusive Design Approach'],
                5: ['Market Opportunity Analysis', 'Competitive Positioning Strategy', 'Demand Forecast Model'],
                6: ['Data Analytics Enhancement', 'ML/AI Integration Strategy', 'Data Quality Framework'],
                7: ['User-Centric Design Proposal', 'Customer Journey Enhancement', 'Pain Point Resolution'],
                8: ['Sustainability Initiative', 'Carbon Footprint Reduction', 'ESG Compliance Strategy'],
                9: ['Technical Architecture Design', 'Implementation Roadmap', 'Technology Stack Optimization'],
                10: ['ROI Maximization Strategy', 'Cost Optimization Framework', 'Budget Allocation Model']
            };
            
            setTimeout(() => {
                selectedAgents.forEach(agentId => {
                    const agent = state.aiRoster.find(a => a.id === agentId);
                    const templates = ideaTemplates[agentId] || ['Strategic Insight', 'Expert Analysis', 'Professional Recommendation'];
                    
                    for (let i = 0; i < ideasPerAgent; i++) {
                        const ideaTitle = templates[i % templates.length];
                        const newIdea = {
                            id: state.currentProject.ideas.length + 1,
                            title: `${ideaTitle} - ${agent.name}`,
                            content: `This is a strategically valuable idea generated by ${agent.name}, based on their expertise in ${agent.description.toLowerCase()}. The recommendation includes detailed analysis and actionable insights for the project.`,
                            submittedBy: agent.name,
                            source: 'ai',
                            submittedDate: new Date()
                        };
                        
                        state.currentProject.ideas.push(newIdea);
                    }
                });
                
                hideLoading();
                state.projectActiveTab = 'ideas';
                showToast(`✓ ${totalIdeas} ideas generated successfully by AI agents!`, 'success');
                render();
            }, 2000);
        }

        function generateAIIdeas() {
            const selectedAgents = Array.from(document.querySelectorAll('.ai-generator-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedAgents.length === 0) {
                showToast('Please select at least one AI agent.', 'error');
                return;
            }
            
            const ideasPerAgent = parseInt(document.getElementById('ideasPerAgent').value);
            const totalIdeas = selectedAgents.length * ideasPerAgent;
            
            closeModal();
            showLoading(`AI agents are generating ${totalIdeas} ideas...`);
            
            // AI idea templates based on agent type
            const ideaTemplates = {
                1: ['Risk Mitigation Strategy', 'Compliance Framework Enhancement', 'Vulnerability Assessment Protocol'],
                2: ['Alternative Approach Analysis', 'Challenge to Current Assumptions', 'Devil\'s Advocate Perspective'],
                3: ['Emerging Technology Integration', 'Innovation Roadmap Proposal', 'Disruptive Solution Concept'],
                4: ['Ethical Impact Assessment', 'Privacy-First Implementation', 'Inclusive Design Approach'],
                5: ['Market Opportunity Analysis', 'Competitive Positioning Strategy', 'Demand Forecast Model'],
                6: ['Technical Architecture Design', 'Implementation Roadmap', 'Technology Stack Optimization'],
                7: ['ROI Maximization Strategy', 'Cost Optimization Framework', 'Budget Allocation Model'],
                8: ['User-Centric Design Proposal', 'Customer Journey Enhancement', 'Pain Point Resolution'],
                9: ['Sustainability Initiative', 'Carbon Footprint Reduction', 'ESG Compliance Strategy'],
                10: ['Legal Compliance Framework', 'Regulatory Risk Assessment', 'Contractual Safeguards'],
                11: ['Data Analytics Enhancement', 'ML/AI Integration Strategy', 'Data Quality Framework'],
                12: ['Process Optimization Plan', 'Scalability Enhancement', 'Operational Efficiency Model'],
                13: ['Change Management Strategy', 'Adoption Acceleration Plan', 'Stakeholder Engagement Framework'],
                14: ['Brand Alignment Strategy', 'Messaging Framework', 'Market Positioning Approach'],
                15: ['Strategic Fit Analysis', 'Long-term Value Creation', 'Competitive Advantage Strategy']
            };
            
            setTimeout(() => {
                selectedAgents.forEach(agentId => {
                    const agent = state.currentProject.aiTeam.find(a => a.id === agentId);
                    const templates = ideaTemplates[agentId] || ['Strategic Insight', 'Expert Analysis', 'Professional Recommendation'];
                    
                    for (let i = 0; i < ideasPerAgent; i++) {
                        const ideaTitle = templates[i % templates.length];
                        const newIdea = {
                            id: state.currentProject.ideas.length + 1,
                            title: `${ideaTitle} - ${agent.name}`,
                            content: `This is a strategically valuable idea generated by ${agent.name}, based on their expertise in ${agent.description.toLowerCase()}. The recommendation includes detailed analysis and actionable insights.`,
                            submittedBy: agent.name,
                            source: 'ai',
                            submittedDate: new Date()
                        };
                        
                        state.currentProject.ideas.push(newIdea);
                    }
                });
                
                hideLoading();
                
                // Direct navigation without extra modal
                showToast(`✓ Generated ${totalIdeas} ideas from ${selectedAgents.length} AI agent(s)`, 'success');
                
                // Auto-switch to Ideas tab to show results
                state.projectActiveTab = 'ideas';
                render();
            }, 2500);
        }

        // Voting Session Wizard
        function startVotingWizard() {
            state.votingWizardStep = 1;
            state.votingWizardData = {};
            renderVotingWizard();
        }

        function renderVotingWizard() {
            const wizard = document.getElementById('wizard');
            wizard.classList.add('active');
            
            document.getElementById('wizardTitle').textContent = 'Create Voting Session';
            
            const steps = [
                { number: 1, label: 'Define Session' },
                { number: 2, label: 'Select Ideas' },
                { number: 3, label: 'Invite Voters' }
            ];

            document.getElementById('wizardSteps').innerHTML = steps.map(step => `
                <div class="wizard-step ${step.number === state.votingWizardStep ? 'active' : ''} ${step.number < state.votingWizardStep ? 'completed' : ''}">
                    <div class="wizard-step-number">${step.number}</div>
                    <span>${step.label}</span>
                </div>
            `).join('');

            if (state.votingWizardStep === 1) {
                renderVotingWizardStep1();
            } else if (state.votingWizardStep === 2) {
                renderVotingWizardStep2();
            } else if (state.votingWizardStep === 3) {
                renderVotingWizardStep3();
            }
        }

        function renderVotingWizardStep1() {
            const today = new Date().toISOString().split('T')[0];
            const nextWeek = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('wizardContent').innerHTML = `
                <div class="card">
                    <h3>Define Voting Session</h3>
                    <form id="votingForm1">
                        <div class="form-group">
                            <label class="form-label">Session Name *</label>
                            <input type="text" class="form-input" id="votingName" required value="${state.votingWizardData.name || ''}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Start Date *</label>
                            <input type="date" class="form-input" id="votingStartDate" required value="${state.votingWizardData.startDate || today}">
                        </div>
                        <div class="form-group">
                            <label class="form-label">End Date *</label>
                            <input type="date" class="form-input" id="votingEndDate" required value="${state.votingWizardData.endDate || nextWeek}">
                        </div>
                    </form>
                </div>
            `;

            document.getElementById('wizardFooter').innerHTML = `
                <button class="btn btn-secondary" onclick="closeWizard()">Cancel</button>
                <button class="btn btn-primary" onclick="votingWizardNext(1)">Next: Select Ideas</button>
            `;
        }

        function renderVotingWizardStep2() {
            document.getElementById('wizardContent').innerHTML = `
                <div class="card">
                    <h3>Select Ideas to Vote On</h3>
                    <div class="checkbox-list">
                        ${state.currentProject.ideas.map(idea => `
                            <label class="checkbox-item">
                                <input type="checkbox" value="${idea.id}" class="idea-checkbox" ${state.votingWizardData.selectedIdeas?.includes(idea.id) ? 'checked' : ''}>
                                <div style="flex: 1;">
                                    <strong>${idea.title}</strong>
                                    <p class="text-muted">${idea.content}</p>
                                    <span class="tag ${idea.source === 'ai' ? 'tag-ai' : 'tag-human'}">${idea.source === 'ai' ? `AI Agent Generated: ${idea.submittedBy}` : `Human: ${idea.submittedBy}`}</span>
                                </div>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            document.getElementById('wizardFooter').innerHTML = `
                <button class="btn btn-secondary" onclick="votingWizardBack(2)">Back</button>
                <button class="btn btn-primary" onclick="votingWizardNext(2)">Next: Invite Voters</button>
            `;
        }

        function renderVotingWizardStep3() {
            document.getElementById('wizardContent').innerHTML = `
                <div class="card">
                    <h3 style="display: flex; align-items: center; margin-bottom: 1rem;">
                        <span class="title-bar"></span>
                        Invite Voters
                    </h3>
                    <p class="text-muted" style="margin-bottom: 2rem;">Select team members and AI agents who will participate in this voting session.</p>
                    
                    <!-- Human Team Section -->
                    <h4 style="display: flex; align-items: center; margin-bottom: 1rem;">
                        <i class="fas fa-users" style="margin-right: 0.5rem; color: var(--primary-blue);"></i>
                        Human Team (${state.currentProject.humanTeam.length})
                    </h4>
                    ${state.currentProject.humanTeam.length === 0 ? `
                        <p class="text-muted" style="margin-bottom: 2rem;">No human team members assigned to this project.</p>
                    ` : `
                        <div style="display: grid; gap: 0.75rem; margin-bottom: 2rem;">
                            ${state.currentProject.humanTeam.map(member => `
                                <label style="background: var(--bg-light); border: 2px solid var(--border-color); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s; display: flex; gap: 1rem; align-items: center;">
                                    <input type="checkbox" value="${member.id}" class="human-voter-checkbox" ${state.votingWizardData.selectedHumans?.includes(member.id) ? 'checked' : ''} style="width: 18px; height: 18px; cursor: pointer;">
                                    <div style="flex: 1;">
                                        <strong style="display: block; font-size: 1rem; color: var(--text-primary);">${member.name}</strong>
                                        <span style="font-size: 0.9rem; color: var(--text-secondary);">${member.email}</span>
                                    </div>
                                    <span class="tag tag-${member.status === 'active' ? 'draft' : 'submitted'}">${member.status === 'active' ? 'Draft' : 'Submitted'}</span>
                                </label>
                            `).join('')}
                        </div>
                    `}
                    
                    <!-- AI Team Section -->
                    <h4 style="display: flex; align-items: center; margin-bottom: 1rem;">
                        <i class="fas fa-robot" style="margin-right: 0.5rem; color: var(--primary-blue);"></i>
                        AI Team (${state.currentProject.aiTeam.length})
                    </h4>
                    ${state.currentProject.aiTeam.length === 0 ? `
                        <p class="text-muted">No AI agents deployed to this project.</p>
                    ` : `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                            ${state.currentProject.aiTeam.map(agent => `
                                <label style="background: white; border: 2px solid var(--border-color); border-radius: 8px; padding: 1rem; cursor: pointer; transition: all 0.2s; display: block; position: relative;">
                                    <input type="checkbox" value="${agent.id}" class="ai-voter-checkbox" ${state.votingWizardData.selectedAI?.includes(agent.id) ? 'checked' : ''} style="position: absolute; top: 1rem; left: 1rem; width: 18px; height: 18px; cursor: pointer;">
                                    
                                    <div style="text-align: center; margin-top: 1.5rem; margin-bottom: 0.75rem;">
                                        <div style="width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 0.5rem;">
                                            👤
                                        </div>
                                        <strong style="display: block; font-size: 0.95rem; color: var(--text-primary); margin-bottom: 0.25rem;">${agent.name}</strong>
                                        <span style="display: block; font-size: 0.8rem; color: var(--text-secondary);">${agent.role || 'AI Expert'}</span>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    `}
                </div>
            `;

            document.getElementById('wizardFooter').innerHTML = `
                <button class="btn btn-secondary" onclick="votingWizardBack(3)">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-success" onclick="launchVotingSession()">
                    <i class="fas fa-rocket"></i> Launch Voting Session
                </button>
            `;
        }

        function votingWizardNext(step) {
            if (step === 1) {
                const name = document.getElementById('votingName').value;
                const startDate = document.getElementById('votingStartDate').value;
                const endDate = document.getElementById('votingEndDate').value;
                
                if (!name || !startDate || !endDate) {
                    showToast('Please fill in all required fields.', 'error');
                    return;
                }
                
                state.votingWizardData.name = name;
                state.votingWizardData.startDate = startDate;
                state.votingWizardData.endDate = endDate;
                state.votingWizardStep = 2;
            } else if (step === 2) {
                const selectedIdeas = Array.from(document.querySelectorAll('.idea-checkbox:checked'))
                    .map(cb => parseInt(cb.value));
                
                if (selectedIdeas.length === 0) {
                    showToast('Please select at least one idea.', 'error');
                    return;
                }
                
                state.votingWizardData.selectedIdeas = selectedIdeas;
                state.votingWizardStep = 3;
            }
            
            renderVotingWizard();
        }

        function votingWizardBack(step) {
            state.votingWizardStep = step - 1;
            renderVotingWizard();
        }

        function launchVotingSession() {
            const selectedHumans = Array.from(document.querySelectorAll('.human-voter-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            const selectedAI = Array.from(document.querySelectorAll('.ai-voter-checkbox:checked'))
                .map(cb => parseInt(cb.value));
            
            if (selectedHumans.length === 0 && selectedAI.length === 0) {
                showToast('Please select at least one voter.', 'error');
                return;
            }
            
            showLoading('Launching voting session...');
            
            setTimeout(() => {
                state.votingWizardData.selectedHumans = selectedHumans;
                state.votingWizardData.selectedAI = selectedAI;
                
                const newSession = {
                    id: state.currentProject.votingSessions.length + 1,
                    name: state.votingWizardData.name,
                    startDate: state.votingWizardData.startDate,
                    endDate: state.votingWizardData.endDate,
                    status: 'active',
                    selectedIdeas: state.votingWizardData.selectedIdeas,
                    humanVoters: selectedHumans,
                    aiVoters: selectedAI,
                    humanVotes: 0,
                    aiVotes: selectedAI.length * state.votingWizardData.selectedIdeas.length,
                    results: state.votingWizardData.selectedIdeas.map(ideaId => ({
                        ideaId: ideaId,
                        humanScore: Math.floor(Math.random() * 10),
                        aiScore: Math.floor(Math.random() * 10),
                        combinedScore: Math.floor(Math.random() * 20)
                    }))
                };
                
                state.currentProject.votingSessions.push(newSession);
                
                // Add notification for participants
                document.getElementById('assignmentNotification').classList.remove('hidden');
                const badge = document.getElementById('assignmentBadge');
                if (badge) {
                    badge.textContent = selectedHumans.length;
                    badge.classList.remove('hidden');
                }
                
                closeWizard();
                hideLoading();
                
                // Direct navigation without extra modal
                showToast(`✓ "${newSession.name}" launched! ${selectedHumans.length} participants notified`, 'success');
                
                // Switch to voting tab
                state.projectActiveTab = 'voting';
                render();
            }, 1200);
        }

        // Assignment Actions
        function viewAssignment(projectId) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            navigateTo('assignments', 'assignment-detail');
        }

        function submitIdea(event, projectId) {
            event.preventDefault();
            
            const title = document.getElementById('ideaTitle').value;
            const content = document.getElementById('ideaContent').value;
            
            if (!title || !content) {
                showToast('Please fill in all fields', 'error');
                return;
            }
            
            showLoading('Submitting your idea...');
            
            setTimeout(() => {
                const newIdea = {
                    id: state.currentProject.ideas.length + 1,
                    title: title,
                    content: content,
                    submittedBy: state.currentUser.name,
                    source: 'human',
                    submittedDate: new Date()
                };
                
                state.currentProject.ideas.push(newIdea);
                
                hideLoading();
                showToast('✓ Your idea has been submitted successfully!', 'success');
                
                // Smooth re-render with form reset
                render();
            }, 600);
        }

        function startVoting(projectId, sessionId) {
            state.currentVotingSession = state.currentProject.votingSessions.find(s => s.id === sessionId);
            navigateTo('assignments', 'voting');
        }

        let userVotes = {};

        function castVote(ideaId, voteType) {
            userVotes[ideaId] = voteType;
            showToast(`Vote recorded for idea #${ideaId}`, 'info');
        }

        function submitAllVotes(projectId, sessionId) {
            const voteCount = Object.keys(userVotes).length;
            
            if (voteCount === 0) {
                showToast('Please cast at least one vote before submitting', 'error');
                return;
            }
            
            showLoading('Submitting your votes...');
            
            setTimeout(() => {
                const session = state.currentProject.votingSessions.find(s => s.id === sessionId);
                session.humanVotes += voteCount;
                
                userVotes = {};
                
                hideLoading();
                
                // Direct navigation without extra modal
                showToast(`✓ ${voteCount} vote(s) submitted! You'll be notified when results are available.`, 'success');
                navigateTo('assignments', 'assignment-detail');
            }, 800);
        }

        // Results Actions
        function viewVotingResults(projectId, sessionId) {
            state.currentProject = state.projects.find(p => p.id === projectId);
            state.currentVotingSession = state.currentProject.votingSessions.find(s => s.id === sessionId);
            navigateTo('workspace', 'voting-results');
        }

        function updateResultsView(viewType) {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = renderResultsView(viewType, state.currentVotingSession, state.currentProject);
        }

        // Tab Navigation
        document.querySelectorAll('.sub-nav-tab').forEach(tab => {
            tab.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = tab.dataset.tab;
                
                // Update active state
                document.querySelectorAll('.sub-nav-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Handle navigation based on tab
                if (tabName === 'strategy') {
                    // Already on Strategy Navigator - maintain current view
                } else {
                    // Other tabs would navigate elsewhere (future implementation)
                    showToast('This module will be available soon', 'info');
                }
        });
      });

        // Update metrics display (deprecated - metrics removed)
        function updateMetrics() {
            // No-op: metrics section removed
        }

        // Reset demo data for fresh presentation
        function resetDemoData() {
            if (!confirm('Reset all data to initial demo state? This will clear all changes.')) {
                return;
            }
            
            showLoading('Resetting demo data...');
            setTimeout(() => {
                hideLoading();
                location.reload();
            }, 800);
        }

        // Keyboard shortcuts for power users
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Ctrl/Cmd + K: Quick search
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    const searchInput = document.getElementById('projectSearch') || document.getElementById('ideaSearch');
                    if (searchInput) searchInput.focus();
                }
                
                // Ctrl/Cmd + N: New project (from dashboard)
                if ((e.ctrlKey || e.metaKey) && e.key === 'n' && state.currentPage === 'dashboard') {
                    e.preventDefault();
                    startProjectWizardFromSlot();
                }
                
                // Ctrl/Cmd + I: New idea (from Ideas tab)
                if ((e.ctrlKey || e.metaKey) && e.key === 'i' && state.projectActiveTab === 'ideas') {
                    e.preventDefault();
                    showManualIdeaForm();
                }
            });
        }

        // Initialize shortcuts
        setupKeyboardShortcuts();

        // Initialize - Simulate user state with comprehensive dummy data
        function initializeDemo() {
            // Set current date
            setCurrentDate();

            // User already has licenses
            state.currentUser.hasLicenses = true;
            state.currentUser.licenses = 25;
            state.currentUser.aiAgents = 25;

            // Provide realistic purchase history (5 project licenses total)
            state.purchaseHistory = [
                { date: 'Nov 1, 2024', package: 'Professional', quantity: 3, amount: 150 },
                { date: 'Nov 10, 2024', package: 'Professional', quantity: 2, amount: 100 }
            ];

            // Add 3 realistic demo projects showcasing different scenarios
            state.projects = [
                {
                    id: 1,
                    name: 'Digital Customer Experience 2025',
                    category: 'Customer Experience',
                    categories: ['Customer Experience', 'Digital Transformation', 'AI and Analytics'],
                    timeline: '2-5y',
                    description: 'Transform our digital touchpoints to create seamless, personalized customer journeys across all platforms',
                    uploadedFiles: [
                        { name: 'CX_Strategy_2025.pdf', size: 2450, type: 'pdf' },
                        { name: 'User_Research_Report.docx', size: 1820, type: 'docx' },
                        { name: 'Market_Analysis_Presentation.pptx', size: 3200, type: 'ppt' }
                    ],
                    purchaseDate: 'Nov 1, 2024',
                    owner: 'User A',
                    created: new Date('2024-11-05'),
                    status: 'active',
                    humanTeam: [
                        { id: 2, name: 'Sarah Johnson', email: 'sarah.johnson@example.com', status: 'active' },
                        { id: 3, name: 'Michael Chen', email: 'michael.chen@example.com', status: 'active' }
                    ],
                    aiTeam: [
                        { id: 3, name: 'Ayu Laksmi', role: 'Behavioral Economics Expert', description: 'Designs around how people really decide. Makes good choices feel easy and natural.' },
                        { id: 5, name: 'Diego Morales', role: 'Global Innovation Director', description: 'Finds opportunities others completely miss. Creates new markets instead of competing.' },
                        { id: 12, name: 'Priya Ramanathan', role: 'AI Transformation Advisor', description: 'Designs AI that amplifies human capabilities. Spots AI hype vs real opportunities.' }
                    ],
                    ideas: [
                        { id: 1, title: 'AI-Powered Personalization Engine', content: 'Implement machine learning to dynamically personalize content, product recommendations, and user interfaces based on individual behavior patterns and preferences', submittedBy: 'Ayu Laksmi', source: 'ai', category: 'AI and Analytics', submittedDate: new Date('2024-11-06') },
                        { id: 2, title: 'Omnichannel Chat Integration', content: 'Unified messaging platform that seamlessly transitions conversations across web, mobile, SMS, and social media channels', submittedBy: 'Sarah Johnson', source: 'human', category: 'AI and Analytics', submittedDate: new Date('2024-11-07') },
                        { id: 3, title: 'Voice-First Interface Prototypes', content: 'Develop voice command capabilities for hands-free navigation and product discovery, particularly for mobile users', submittedBy: 'Diego Morales', source: 'ai', category: 'AI and Analytics', submittedDate: new Date('2024-11-08') }
                    ],
                    votingSessions: [
                        { id: 1, name: 'Q4 CX Prioritization', startDate: '2024-11-12', endDate: '2024-11-22', status: 'completed', selectedIdeas: [1, 2, 3], humanVoters: [2, 3], aiVoters: [3, 5, 12], humanVotes: 3, aiVotes: 3, results: [
                            { ideaId: 1, humanScore: 9, aiScore: 9, combinedScore: 18 },
                            { ideaId: 2, humanScore: 8, aiScore: 7, combinedScore: 15 },
                            { ideaId: 3, humanScore: 7, aiScore: 8, combinedScore: 15 }
                        ]}
                    ]
                },
                {
                    id: 2,
                    name: 'Sustainability & ESG Initiative',
                    category: 'Sustainability',
                    categories: ['Sustainability', 'ESG', 'Environmental'],
                    timeline: '5-10y',
                    description: 'Build comprehensive environmental, social, and governance framework aligned with 2030 climate goals',
                    uploadedFiles: [
                        { name: 'ESG_Framework_2030.pdf', size: 1890, type: 'pdf' },
                        { name: 'Carbon_Footprint_Analysis.pdf', size: 2150, type: 'pdf' }
                    ],
                    purchaseDate: 'Nov 1, 2024',
                    owner: 'User A',
                    created: new Date('2024-10-20'),
                    status: 'active',
                    humanTeam: [
                        { id: 4, name: 'Emily Rodriguez', email: 'emily.rodriguez@example.com', status: 'active' }
                    ],
                    aiTeam: [
                        { id: 13, name: 'Robert Whitaker', role: 'Ethics and Equity Advisor', description: 'Ensures solutions benefit everyone fairly. Spots and fixes bias before it causes harm.' },
                        { id: 16, name: 'Climate Tech Specialist', role: 'Environmental Tech', description: 'Analyzes carbon reduction technologies' }
                    ],
                    ideas: [
                        { id: 4, title: 'Carbon Neutrality Roadmap 2030', content: 'Comprehensive strategy to achieve net-zero carbon emissions across all operations by 2030, including renewable energy transition and carbon offset investments', submittedBy: 'Robert Whitaker', source: 'ai', category: 'Sustainability', submittedDate: new Date('2024-10-21') },
                        { id: 5, title: 'Circular Economy Packaging', content: 'Redesign all product packaging to be 100% recyclable or compostable, with take-back programs for product end-of-life', submittedBy: 'Climate Tech Specialist', source: 'ai', category: 'Sustainability', submittedDate: new Date('2024-10-22') }
                    ],
                    votingSessions: []
                }
            ];

            // Add 1 realistic draft project
            state.draftProjects = [
                {
                    name: 'AI-Powered Operations Optimization',
                    category: 'Operations',
                    timeline: '0-2y',
                    description: 'Leverage artificial intelligence to streamline warehouse operations, optimize inventory, and reduce operational costs by 30%',
                    selectedAI: [11, 6, 7], // Operations Optimizer, Tech Evaluator, Financial Advisor
                    draftId: Date.now()
                }
            ];

            // Hide metrics if present
            const metricsEl = document.getElementById('metricsSection');
            if (metricsEl) metricsEl.style.display = 'none';

            render();
        }

        // First-time user guidance
        function showFirstTimeGuidance() {
            if (!localStorage.getItem('strategy_navigator_visited')) {
                setTimeout(() => {
                    showModal(
                        'Welcome to Strategy Navigator! 👋',
                        `
                            <div style="text-align: left; line-height: 1.8;">
                                <p><strong>Choose Your Hat:</strong></p>
                                <ul style="margin-left: 1.5rem; margin-bottom: 1.5rem;">
                                    <li><strong>My Workspace (Owner)</strong> - Create projects, deploy AI, manage teams</li>
                                    <li><strong>My Assignments (Participant)</strong> - Contribute ideas and vote</li>
                                </ul>
                                <p style="margin-bottom: 0;">Switch between contexts anytime using the tabs above!</p>
                            </div>
                        `,
                        `
                            <button class="btn btn-primary" onclick="closeModal(); localStorage.setItem('strategy_navigator_visited', 'true')">
                                Got it! Let's Go <i class="fas fa-arrow-right"></i>
                            </button>
                        `
                    );
                }, 1000);
            }
        }

        // Keyboard shortcuts for better navigation
        document.addEventListener('keydown', function(e) {
            // ESC to close modals and wizards
            if (e.key === 'Escape') {
                const modalOverlay = document.getElementById('modalOverlay');
                const wizard = document.getElementById('wizard');
                
                if (modalOverlay.classList.contains('active')) {
                    closeModal();
                } else if (wizard.classList.contains('active')) {
                    if (confirm('Are you sure you want to cancel? Your progress will be lost.')) {
                        closeWizard();
                    }
                }
            }
        });

        // Prevent accidental page navigation
        window.addEventListener('beforeunload', function(e) {
            const wizard = document.getElementById('wizard');
            if (wizard.classList.contains('active')) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                return e.returnValue;
            }
        });

        // Start the app
        initializeDemo();
        
        // Show first-time guidance (commented out for demo, uncomment for production)
        // showFirstTimeGuidance();

        function toggleProjectSort(column) {
            const sort = state.dashboardSort || { column: null, direction: null };
            if (sort.column !== column) {
                state.dashboardSort = { column, direction: 'asc' };
            } else {
                state.dashboardSort.direction = sort.direction === 'asc' ? 'desc' : (sort.direction === 'desc' ? null : 'asc');
                if (!state.dashboardSort.direction) state.dashboardSort.column = null;
            }
            render();
        }

        function getSortIndicator(column) {
            const sort = state.dashboardSort || { column: null, direction: null };
            if (sort.column !== column) {
                return '<i class="fas fa-sort" style="opacity:0.4;"></i>';
            }
            if (sort.direction === 'asc') {
                return '<i class="fas fa-sort-up" style="color:var(--primary-blue);"></i>';
            }
            if (sort.direction === 'desc') {
                return '<i class="fas fa-sort-down" style="color:var(--primary-blue);"></i>';
            }
            return '<i class="fas fa-sort" style="opacity:0.4;"></i>';
        }

        function formatDate(dateLike) {
            if (!dateLike) return '—';
            // Handle date strings like "Nov 1, 2024" from purchase history
            if (typeof dateLike === 'string' && dateLike.match(/^[A-Za-z]{3}\s+\d{1,2},\s+\d{4}$/)) {
                const d = new Date(dateLike);
                if (!isNaN(d.getTime())) {
                    return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
                }
            }
            const d = (dateLike instanceof Date) ? dateLike : new Date(dateLike);
            if (isNaN(d.getTime())) return '—';
            return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: '2-digit' });
        }

        function getInventoryData(availableSlots) {
            const rows = [];
            // Get purchase dates from purchase history (most recent first)
            const purchaseDates = state.purchaseHistory.map(tx => tx.date).sort().reverse();
            let purchaseDateIndex = 0;
            
            for (let i = 0; i < availableSlots; i += 1) {
                const purchaseDate = purchaseDates[purchaseDateIndex] || null;
                rows.push({ type: 'slot', name: 'New Project', status: 'Available', created: null, purchaseDate: purchaseDate, ideas: 0, agents: 0 });
                purchaseDateIndex = (purchaseDateIndex + 1) % purchaseDates.length;
            }
            state.draftProjects.forEach((d, di) => {
                rows.push({ type: 'draft', name: d.name || 'Untitled Project', status: 'Draft', created: d.created || null, purchaseDate: null, ideas: 0, agents: 0, draftIndex: di });
            });
            state.projects.forEach((p) => {
                // Try to find purchase date - use created date as fallback or null
                const purchaseDate = p.purchaseDate || null;
                rows.push({ type: 'project', id: p.id, name: p.name, status: 'Active', created: p.created || p.createdDate || null, purchaseDate: purchaseDate, ideas: (p.ideas?.length || 0), agents: (p.aiTeam?.length || 0) });
            });
            return rows;
        }

        function sortInventoryRows(rows) {
            const sort = state.dashboardSort;
            if (!sort || !sort.column || !sort.direction) return rows;
            const dir = sort.direction === 'asc' ? 1 : -1;
            const statusOrderAsc = { 'Active': 0, 'Draft': 1, 'Available': 2 };
            const statusOrderDesc = { 'Active': 1, 'Draft': 0, 'Available': -1 };
            const statusOrder = sort.direction === 'asc' ? statusOrderAsc : statusOrderDesc;
            return [...rows].sort((a, b) => {
                if (sort.column === 'ideas') return (a.ideas - b.ideas) * dir;
                if (sort.column === 'agents') return (a.agents - b.agents) * dir;
                if (sort.column === 'created') {
                    const at = a.created ? new Date(a.created).getTime() : 0;
                    const bt = b.created ? new Date(b.created).getTime() : 0;
                    return (at - bt) * dir;
                }
                if (sort.column === 'purchase') {
                    const at = a.purchaseDate ? new Date(a.purchaseDate).getTime() : 0;
                    const bt = b.purchaseDate ? new Date(b.purchaseDate).getTime() : 0;
                    return (at - bt) * dir;
                }
                if (sort.column === 'status') return ((statusOrder[a.status] ?? 99) - (statusOrder[b.status] ?? 99));
                // name alphabetical
                const av = (a[sort.column] || '').toString().toLowerCase();
                const bv = (b[sort.column] || '').toString().toLowerCase();
                if (av < bv) return -1 * dir;
                if (av > bv) return 1 * dir;
                return 0;
            });
        }

        function renderInventoryRow(item, index) {
            if (item.type === 'slot') {
                return `
                    <tr class="selectable" onclick="startProjectWizardFromSlot()" style="cursor:pointer;">
                        <td class="nowrap">${index + 1}</td>
                        <td class="ellipsis"><strong style="color:var(--primary-blue);">${item.name}</strong></td>
                        <td class="nowrap">${item.purchaseDate ? formatDate(item.purchaseDate) : '—'}</td>
                        <td class="nowrap">—</td>
                        <td class="nowrap"><span class="tag tag-available">Available</span></td>
                        <td class="nowrap" style="text-align:center;">0</td>
                        <td style="text-align:center;">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation();startProjectWizardFromSlot();return false;" style="min-width:96px; border-radius:8px;">
                                Set Up
                            </button>
                        </td>
                     </tr>
                `;
            }
            if (item.type === 'draft') {
                return `
                    <tr onclick="resumeDraft(${item.draftIndex})" style="cursor:pointer;">
                        <td class="nowrap">${index + 1}</td>
                        <td class="ellipsis"><strong>${item.name}</strong></td>
                        <td class="nowrap">—</td>
                        <td class="nowrap">${formatDate(item.created)}</td>
                        <td class="nowrap"><span class="tag tag-submitted" style="background:#fff3cd;color:#856404;">Draft</span></td>
                        <td class="nowrap" style="text-align:center;">0</td>
                        <td style="text-align:center;">
                            <button class="btn btn-sm btn-outline" onclick="event.stopPropagation();resumeDraft(${item.draftIndex});return false;" style="min-width:96px; border-radius:8px;">
                                Resume
                            </button>
                        </td>
                     </tr>
                `;
            }
            // project
            return `
                <tr style="cursor:pointer;">
                    <td class="nowrap" onclick="viewProjectAgents(${item.id})">${index + 1}</td>
                    <td class="ellipsis" onclick="viewProjectAgents(${item.id})"><strong>${item.name}</strong></td>
                    <td class="nowrap" onclick="viewProjectAgents(${item.id})">${item.purchaseDate ? formatDate(item.purchaseDate) : '—'}</td>
                    <td class="nowrap" onclick="viewProjectAgents(${item.id})">${formatDate(item.created)}</td>
                    <td class="nowrap" onclick="viewProjectAgents(${item.id})"><span class="tag tag-active">Active</span></td>
                    <td class="nowrap" style="text-align:center;">${item.agents || 0}</td>
                    <td style="text-align:center;">
                        <button class="btn btn-sm" onclick="event.stopPropagation();viewProjectAgents(${item.id});return false;" style="min-width:96px; border-radius:8px;">
                            Manage
                        </button>
                    </td>
                 </tr>
            `;
        }
    </script>
</body>
</html>